<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RenewalScan AI — Policy Comparison</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --navy: #0f2744; --navy-light: #1a3a5c; --blue: #2563eb; --blue-light: #3b82f6;
      --green: #059669; --red: #dc2626; --amber: #d97706;
      --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0;
      --gray-400: #94a3b8; --gray-600: #4b5563; --gray-700: #374151; --gray-900: #111827;
      --white: #ffffff; --shadow: 0 4px 24px rgba(15,39,68,.10); --shadow-lg: 0 8px 40px rgba(15,39,68,.16);
      --radius: 12px; --radius-sm: 8px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; color: var(--gray-700); background: var(--gray-50); line-height: 1.6; min-height: 100vh; }

    /* NAV */
    nav { background: var(--navy); padding: 0 24px; position: sticky; top: 0; z-index: 100; }
    .nav-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 60px; }
    .nav-logo { color: #fff; font-size: 20px; font-weight: 800; letter-spacing: -0.5px; cursor: pointer; }
    .nav-logo span { color: var(--blue-light); }
    .nav-links { display: flex; align-items: center; gap: 8px; }
    .nav-link { color: #94a3b8; font-size: 14px; font-weight: 500; padding: 8px 14px; border-radius: 6px; cursor: pointer; transition: color .15s, background .15s; border: none; background: none; font-family: 'Inter', sans-serif; }
    .nav-link:hover { color: #fff; background: rgba(255,255,255,.08); }
    .nav-btn { background: var(--blue); color: #fff; font-size: 14px; font-weight: 600; padding: 8px 18px; border-radius: 6px; cursor: pointer; border: none; transition: background .15s; font-family: 'Inter', sans-serif; }
    .nav-btn:hover { background: var(--blue-light); }
    .nav-user { display: flex; align-items: center; gap: 10px; }
    .nav-user-chip { display:inline-flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,.22); border-radius:99px; padding:4px 14px 4px 4px; background:rgba(255,255,255,.06); }
    .nav-user-avatar { width:28px; height:28px; border-radius:50%; background:var(--blue); color:#fff; font-size:12px; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .nav-user-name { color:#fff; font-size:13px; font-weight:500; }
    .nav-signout { color: #94a3b8; font-size: 13px; cursor: pointer; border: none; background: none; padding: 6px 10px; border-radius: 6px; font-family: 'Inter', sans-serif; }
    .nav-signout:hover { color: #fff; background: rgba(255,255,255,.08); }
    @media (max-width: 600px) { .nav-link { display: none; } }

    /* PAGES */
    .page { display: none; }
    .page.active { display: block; }
    .page-auth { display: none; }
    .page-auth.active { display: grid; }
    @media (max-width: 768px) { .page-auth.active { display: flex; flex-direction: column; } }

    /* LANDING */
    .hero { background: linear-gradient(135deg, var(--navy) 0%, #1e3a5f 100%); color: #fff; padding: 80px 24px; text-align: center; }
    .hero-inner { max-width: 720px; margin: 0 auto; }
    .hero-badge { display: inline-block; background: rgba(37,99,235,.25); border: 1px solid rgba(59,130,246,.4); color: #93c5fd; font-size: 12px; font-weight: 600; padding: 5px 14px; border-radius: 20px; letter-spacing: .5px; text-transform: uppercase; margin-bottom: 24px; }
    .hero h1 { font-size: clamp(28px, 5vw, 52px); font-weight: 800; line-height: 1.15; letter-spacing: -1px; margin-bottom: 20px; }
    .hero h1 span { color: #60a5fa; }
    .hero p { font-size: 18px; color: #94a3b8; margin-bottom: 36px; max-width: 520px; margin-left: auto; margin-right: auto; }
    .hero-cta { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .btn-primary { background: var(--blue); color: #fff; border: none; padding: 14px 28px; border-radius: var(--radius-sm); font-size: 15px; font-weight: 600; cursor: pointer; transition: background .15s, transform .1s; font-family: 'Inter', sans-serif; }
    .btn-primary:hover { background: var(--blue-light); transform: translateY(-1px); }
    .btn-outline { background: transparent; color: #fff; border: 1.5px solid rgba(255,255,255,.3); padding: 14px 28px; border-radius: var(--radius-sm); font-size: 15px; font-weight: 600; cursor: pointer; transition: border-color .15s, background .15s; font-family: 'Inter', sans-serif; }
    .btn-outline:hover { border-color: #fff; background: rgba(255,255,255,.08); }
    .hero-stats { display: flex; gap: 40px; justify-content: center; margin-top: 52px; flex-wrap: wrap; }
    .stat { text-align: center; }
    .stat-num { font-size: 28px; font-weight: 800; color: #fff; }
    .stat-label { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: .5px; margin-top: 2px; }
    .content-section { max-width: 1100px; margin: 0 auto; padding: 60px 24px; }
    .section-title { font-size: 28px; font-weight: 700; color: var(--navy); text-align: center; margin-bottom: 8px; }
    .section-sub { font-size: 16px; color: var(--gray-600); text-align: center; margin-bottom: 44px; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
    .card { background: var(--white); border-radius: var(--radius); padding: 28px; box-shadow: var(--shadow); border: 1px solid var(--gray-200); }
    .card-icon { font-size: 28px; margin-bottom: 14px; }
    .card h3 { font-size: 17px; font-weight: 700; color: var(--navy); margin-bottom: 8px; }
    .card p { font-size: 14px; color: var(--gray-600); line-height: 1.6; }
    .steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 32px; }
    .step { text-align: center; }
    .step-num { width: 48px; height: 48px; background: var(--blue); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; margin: 0 auto 16px; }
    .step h3 { font-size: 16px; font-weight: 600; color: var(--navy); margin-bottom: 6px; }
    .step p { font-size: 14px; color: var(--gray-600); }
    .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; }
    .price-card { background: #fff; border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 28px; position: relative; box-shadow: var(--shadow); }
    .price-card.featured { border-color: var(--blue); border-width: 2px; }
    .price-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--blue); color: #fff; font-size: 11px; font-weight: 700; padding: 4px 14px; border-radius: 20px; text-transform: uppercase; letter-spacing: .5px; white-space: nowrap; }
    .price-name { font-size: 16px; font-weight: 700; color: var(--navy); margin-bottom: 6px; }
    .price-amount { font-size: 32px; font-weight: 800; color: var(--navy); }
    .price-period { font-size: 13px; color: var(--gray-400); font-weight: 400; }
    .price-limit { font-size: 13px; color: var(--gray-600); margin: 12px 0 20px; }
    .price-features { list-style: none; }
    .price-features li { font-size: 13px; color: var(--gray-600); padding: 5px 0; display: flex; align-items: center; gap: 8px; }
    .price-features li::before { content: '✓'; color: var(--green); font-weight: 700; }
    footer { background: var(--navy); color: #4b5563; text-align: center; padding: 28px 24px; font-size: 13px; }

    /* AUTH — Split screen */
    .page-auth { min-height: calc(100vh - 60px); grid-template-columns: 1fr 1fr; }
    @media (max-width: 768px) { .page-auth { grid-template-columns: 1fr; } .auth-left { display: none; } }
    .auth-left { background: linear-gradient(160deg, var(--navy) 0%, #0b1e35 100%); display: flex; flex-direction: column; justify-content: center; padding: 64px 52px; position: relative; overflow: hidden; }
    .auth-left::after { content: ''; position: absolute; bottom: -120px; right: -80px; width: 380px; height: 380px; border-radius: 50%; background: radial-gradient(circle, rgba(37,99,235,.12) 0%, transparent 65%); pointer-events: none; }
    .auth-left-logo { font-size: 22px; font-weight: 800; color: #fff; letter-spacing: -0.5px; margin-bottom: 52px; }
    .auth-left-logo span { color: var(--blue-light); }
    .auth-left h2 { font-size: 30px; font-weight: 800; color: #fff; line-height: 1.25; letter-spacing: -0.5px; margin-bottom: 14px; }
    .auth-left p { font-size: 15px; color: #64748b; line-height: 1.7; margin-bottom: 44px; }
    .auth-features { display: flex; flex-direction: column; gap: 22px; }
    .auth-feature { display: flex; align-items: flex-start; gap: 14px; }
    .auth-feature-icon { width: 40px; height: 40px; background: rgba(37,99,235,.15); border: 1px solid rgba(59,130,246,.25); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .auth-feature-text strong { display: block; font-size: 14px; font-weight: 600; color: #e2e8f0; margin-bottom: 3px; }
    .auth-feature-text span { font-size: 13px; color: #475569; }
    .auth-right { background: #fff; display: flex; align-items: center; justify-content: center; padding: 64px 52px; }
    @media (max-width: 768px) { .auth-right { padding: 40px 24px; min-height: calc(100vh - 60px); } }
    .auth-form-wrap { width: 100%; max-width: 360px; }
    .auth-form-title { font-size: 26px; font-weight: 800; color: var(--navy); margin-bottom: 6px; letter-spacing: -0.5px; }
    .auth-form-sub { font-size: 14px; color: var(--gray-600); margin-bottom: 28px; }
    .method-select { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 24px; }
    .method-btn { border: 2px solid var(--gray-200); background: #fff; border-radius: var(--radius-sm); padding: 14px 10px; cursor: pointer; text-align: center; transition: all .2s; font-family: 'Inter', sans-serif; }
    .method-btn:hover { border-color: var(--blue-light); background: #f8faff; }
    .method-btn.active { border-color: var(--blue); background: #eff6ff; }
    .method-btn-icon { font-size: 22px; margin-bottom: 5px; }
    .method-btn-label { font-size: 12px; font-weight: 700; color: var(--navy); }
    .form-group { margin-bottom: 18px; }
    label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; }
    input[type="email"], input[type="password"], input[type="text"], input[type="tel"] {
      width: 100%; padding: 12px 14px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm);
      font-size: 14px; font-family: 'Inter', sans-serif; color: var(--gray-900); background: #fff;
      transition: border-color .15s, box-shadow .15s; outline: none;
    }
    input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(37,99,235,.10); }
    .input-hint { font-size: 12px; color: var(--gray-400); margin-top: 5px; }
    .btn-full { width: 100%; padding: 13px; background: var(--blue); color: #fff; border: none; border-radius: var(--radius-sm); font-size: 15px; font-weight: 600; cursor: pointer; transition: background .15s, transform .1s; font-family: 'Inter', sans-serif; }
    .btn-full:hover { background: var(--blue-light); transform: translateY(-1px); }
    .btn-full:disabled { opacity: .55; cursor: not-allowed; transform: none; }
    .btn-secondary-full { width: 100%; padding: 12px; background: var(--gray-50); color: var(--navy); border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: background .15s; margin-top: 10px; }
    .btn-secondary-full:hover { background: var(--gray-100); }
    .auth-link { text-align: center; font-size: 13px; color: var(--gray-600); margin-top: 22px; }
    .auth-link a { color: var(--blue); cursor: pointer; font-weight: 600; text-decoration: none; }
    .auth-link a:hover { text-decoration: underline; }
    .msg-error { background: #fef2f2; border: 1px solid #fca5a5; border-radius: var(--radius-sm); padding: 10px 14px; font-size: 13px; color: #dc2626; margin-bottom: 16px; display: none; }
    .msg-error.show { display: block; }
    .msg-success { background: #f0fdf4; border: 1px solid #86efac; border-radius: var(--radius-sm); padding: 10px 14px; font-size: 13px; color: #16a34a; margin-bottom: 16px; display: none; }
    .msg-success.show { display: block; }
    .verify-icon-wrap { width: 72px; height: 72px; background: #eff6ff; border: 2px solid rgba(37,99,235,.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 24px; }

    /* DASHBOARD */
    .dash-wrap { max-width: 1000px; margin: 0 auto; padding: 40px 24px; }
    .dash-welcome { font-size: 26px; font-weight: 700; color: var(--navy); margin-bottom: 4px; }
    .dash-sub { font-size: 15px; color: var(--gray-600); margin-bottom: 28px; }
    .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 28px; }
    .dash-card { background: #fff; border-radius: var(--radius); padding: 28px; box-shadow: var(--shadow); border: 1px solid var(--gray-200); position: relative; overflow: hidden; }
    .dash-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--blue); border-radius: var(--radius) var(--radius) 0 0; }
    .dash-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px; color: var(--gray-400); margin-bottom: 12px; }
    .dash-value { font-size: 40px; font-weight: 800; color: var(--navy); line-height: 1; }
    .dash-card-sub { font-size: 13px; color: var(--gray-600); margin-top: 8px; }
    .usage-bar-wrap { margin-top: 16px; background: var(--gray-100); border-radius: 99px; height: 6px; overflow: hidden; }
    .usage-bar { height: 100%; background: var(--blue); border-radius: 99px; transition: width .6s ease; }
    .dash-plan-name { font-size: 26px; font-weight: 800; color: var(--navy); margin-top: 4px; margin-bottom: 10px; }
    .dash-active-badge { display: inline-flex; align-items: center; gap: 6px; background: #f0fdf4; border: 1px solid #bbf7d0; color: #15803d; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 99px; }
    .dash-active-dot { width: 7px; height: 7px; border-radius: 50%; background: #22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,.25); animation: pulse-green 2s infinite; }
    @keyframes pulse-green { 0%,100% { box-shadow: 0 0 0 2px rgba(34,197,94,.25); } 50% { box-shadow: 0 0 0 4px rgba(34,197,94,.1); } }
    .dash-plan-limit { font-size: 12px; color: var(--gray-400); margin-top: 8px; }
    .dash-upgrade-link { display: inline-block; margin-top: 12px; font-size: 12px; font-weight: 600; color: var(--blue); cursor: pointer; text-decoration: none; }
    .dash-upgrade-link:hover { text-decoration: underline; }
    .dash-cta { background: linear-gradient(135deg, var(--navy) 0%, #1e3a5f 100%); border-radius: var(--radius); padding: 32px; color: #fff; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
    .dash-cta h2 { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
    .dash-cta p { font-size: 14px; color: #94a3b8; }
    .dash-section-title { font-size: 17px; font-weight: 700; color: var(--navy); margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
    .dash-section-title span { font-size: 12px; font-weight: 500; color: var(--gray-400); }
    .btn-white { background: #fff; color: var(--navy); border: none; padding: 12px 24px; border-radius: var(--radius-sm); font-size: 15px; font-weight: 700; cursor: pointer; transition: background .15s; white-space: nowrap; font-family: 'Inter', sans-serif; }
    .btn-white:hover { background: var(--gray-100); }

    /* COMPARE */
    .compare-wrap { max-width: 900px; margin: 0 auto; padding: 40px 24px; }
    .compare-title { font-size: 24px; font-weight: 700; color: var(--navy); margin-bottom: 6px; }
    .compare-sub { font-size: 15px; color: var(--gray-600); margin-bottom: 28px; }

    /* Progress steps */
    .progress-steps { display: flex; align-items: center; margin-bottom: 32px; }
    .ps-step { display: flex; align-items: center; gap: 8px; }
    .ps-circle { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; border: 2px solid var(--gray-200); color: var(--gray-400); background: #fff; transition: all .3s; flex-shrink: 0; }
    .ps-circle.active { border-color: var(--blue); color: var(--blue); background: #eff6ff; }
    .ps-circle.done { border-color: var(--green); background: var(--green); color: #fff; }
    .ps-label { font-size: 13px; font-weight: 600; color: var(--gray-400); transition: color .3s; }
    .ps-label.active { color: var(--navy); }
    .ps-label.done { color: var(--green); }
    .ps-connector { flex: 1; height: 2px; background: var(--gray-200); margin: 0 10px; transition: background .3s; }
    .ps-connector.done { background: var(--green); }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Auth-init loader — covers flash of wrong page on refresh */
    #page-loader { position:fixed; inset:0; background:#fff; z-index:9999; display:flex; align-items:center; justify-content:center; transition:opacity .25s ease; }
    #page-loader.hidden { opacity:0; pointer-events:none; }
    #page-loader .pl-spin { width:30px; height:30px; border:3px solid var(--gray-200); border-top-color:var(--blue); border-radius:50%; animation:spin .7s linear infinite; }

    /* Upload */
    .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    @media (max-width: 600px) { .upload-grid { grid-template-columns: 1fr; } }
    .upload-zone { border: 2px dashed var(--gray-200); border-radius: var(--radius); padding: 32px 20px; text-align: center; cursor: pointer; transition: border-color .2s, background .2s; background: #fff; position: relative; }
    .upload-zone:hover, .upload-zone.drag-over { border-color: var(--blue); background: #eff6ff; }
    .upload-zone.loaded { border-color: var(--green); background: #f0fdf4; border-style: solid; }
    .upload-icon { font-size: 32px; margin-bottom: 8px; }
    .upload-label-text { font-size: 14px; font-weight: 600; color: var(--navy); margin-bottom: 4px; }
    .upload-hint-text { font-size: 12px; color: var(--gray-400); }
    .upload-filename { font-size: 13px; font-weight: 600; color: var(--green); margin-top: 8px; word-break: break-all; }
    .upload-input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .btn-compare { width: 100%; padding: 14px; background: var(--blue); color: #fff; border: none; border-radius: var(--radius-sm); font-size: 16px; font-weight: 700; cursor: pointer; transition: background .15s; font-family: 'Inter', sans-serif; }
    .btn-compare:hover:not(:disabled) { background: var(--blue-light); }
    .btn-compare:disabled { opacity: .5; cursor: not-allowed; }

    /* Processing */
    .processing { text-align: center; padding: 60px 20px; display: none; }
    .processing.show { display: block; }
    .spinner { width: 52px; height: 52px; border: 4px solid var(--gray-200); border-top-color: var(--blue); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    .proc-text { font-size: 18px; font-weight: 600; color: var(--navy); }
    .proc-sub { font-size: 14px; color: var(--gray-600); margin-top: 6px; }

    /* Results */
    .results { display: none; }
    .results.show { display: block; }
    .results-hdr { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; }
    .results-title { font-size: 20px; font-weight: 700; color: var(--navy); }
    .results-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-copy { background: var(--navy); color: #fff; border: none; padding: 10px 18px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; transition: background .15s; font-family: 'Inter', sans-serif; }
    .btn-copy:hover { background: var(--navy-light); }
    .btn-copy.copied { background: var(--green); }
    .btn-reset { background: var(--gray-100); color: var(--navy); border: 1.5px solid var(--gray-200); padding: 10px 18px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; }
    .btn-reset:hover { background: var(--gray-200); }
    .result-box { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--gray-200); }
    .result-head { background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); padding: 24px 28px; }
    .result-client { font-size: 20px; font-weight: 700; color: #fff; }
    .result-period { font-size: 13px; color: #94a3b8; margin-top: 4px; }
    .result-body { padding: 24px 28px; }
    .totals-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 18px; }
    @media (max-width: 480px) { .totals-row { grid-template-columns: 1fr; } }
    .total-box { padding: 18px; border-radius: var(--radius-sm); text-align: center; }
    .total-box.old { background: #fff8e1; border: 1px solid #fcd34d; border-left: 4px solid #f59e0b; }
    .total-box.new { background: #ecfdf5; border: 1px solid #6ee7b7; border-left: 4px solid #10b981; }
    .total-box-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px; }
    .total-box.old .total-box-label { color: #92400e; }
    .total-box.new .total-box-label { color: #065f46; }
    .total-box-amount { font-size: 26px; font-weight: 800; }
    .total-box.old .total-box-amount { color: #d97706; }
    .total-box.new .total-box-amount { color: #059669; }
    .change-banner { padding: 12px 16px; border-radius: var(--radius-sm); text-align: center; margin-bottom: 18px; }
    .change-banner.inc { background: #fef2f2; border: 1px solid #fca5a5; }
    .change-banner.dec { background: #f0fdf4; border: 1px solid #86efac; }
    .change-banner.inc .cb-text { color: #dc2626; font-size: 16px; font-weight: 700; }
    .change-banner.dec .cb-text { color: #16a34a; font-size: 16px; font-weight: 700; }
    .sect-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .8px; color: var(--navy); background: var(--gray-50); border-left: 3px solid var(--blue); padding: 8px 12px; border-radius: 0 6px 6px 0; margin-bottom: 14px; }
    .changes-tbl { width: 100%; border-collapse: collapse; margin-bottom: 4px; }
    .changes-tbl th { background: var(--navy); color: #fff; font-size: 11px; font-weight: 600; padding: 10px 12px; text-align: left; text-transform: uppercase; letter-spacing: .5px; }
    .changes-tbl th:not(:first-child) { text-align: right; }
    .changes-tbl td { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid var(--gray-200); }
    .changes-tbl td:not(:first-child) { text-align: right; }
    .changes-tbl tr:last-child td { border-bottom: none; }
    .changes-tbl tr:nth-child(even) td { background: var(--gray-50); }
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--navy); color: #fff; padding: 12px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; box-shadow: var(--shadow-lg); transform: translateY(80px); opacity: 0; transition: all .3s; z-index: 999; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .update-bar { position: fixed; bottom: 24px; left: 24px; background: var(--navy); color: #fff; padding: 12px 18px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px; transform: translateY(80px); opacity: 0; transition: all .3s; z-index: 999; pointer-events: none; }
    .update-bar.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
    .update-bar-btn { background: var(--blue); color: #fff; border: none; padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: Inter,sans-serif; transition: background .15s; }
    .update-bar-btn:hover { background: var(--blue-light); }
    .update-bar-dismiss { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 18px; line-height: 1; padding: 0 2px; font-family: Inter,sans-serif; }

    /* TESTIMONIALS + FAQ */
    .testimonials-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
    .testimonial-card { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--gray-200); padding: 28px; }
    .testimonial-text { font-size: 15px; color: var(--gray-600); line-height: 1.75; font-style: italic; margin-bottom: 16px; }
    .testimonial-author { font-size: 13px; font-weight: 600; color: var(--navy); }
    .faq-list { max-width: 720px; margin: 0 auto; }
    .faq-item { border-bottom: 1px solid var(--gray-200); }
    .faq-q { width: 100%; text-align: left; padding: 18px 0; background: none; border: none; font-size: 15px; font-weight: 600; color: var(--navy); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: 'Inter', sans-serif; gap: 16px; }
    .faq-arrow { font-size: 12px; color: var(--gray-400); flex-shrink: 0; transition: transform .2s; }
    .faq-item.open .faq-arrow { transform: rotate(180deg); }
    .faq-a { display: none; padding: 0 0 18px; font-size: 14px; color: var(--gray-600); line-height: 1.75; }
    .faq-item.open .faq-a { display: block; }

    /* WHY PAGE */
    .why-hero { background: linear-gradient(135deg, var(--navy) 0%, #1e3a5f 100%); color: #fff; padding: 64px 24px; text-align: center; }
    .why-hero h1 { font-size: clamp(24px, 4vw, 42px); font-weight: 800; line-height: 1.2; letter-spacing: -.5px; margin-bottom: 16px; }
    .why-hero p { font-size: 17px; color: #cbd5e1; max-width: 580px; margin: 0 auto 28px; line-height: 1.7; }
    .why-cta-strip { background: var(--navy); color: #fff; padding: 56px 24px; text-align: center; }
    .why-cta-strip h2 { font-size: clamp(20px, 3vw, 32px); font-weight: 700; margin-bottom: 12px; }
    .why-cta-strip p { color: #94a3b8; margin-bottom: 28px; font-size: 15px; }
    .quotescan-banner { background: linear-gradient(135deg, var(--blue) 0%, #1d4ed8 100%); color: #fff; padding: 40px 24px; text-align: center; }
    .quotescan-banner h3 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .quotescan-banner p { color: rgba(255,255,255,.8); font-size: 15px; margin-bottom: 20px; }
    .btn-outline-white { background: transparent; color: #fff; border: 1.5px solid rgba(255,255,255,.5); padding: 11px 24px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; transition: border-color .15s, background .15s; font-family: Inter,sans-serif; text-decoration: none; display: inline-block; }
    .btn-outline-white:hover { border-color: #fff; background: rgba(255,255,255,.1); }
    /* SUBSCRIBE PAGE */
    .subscribe-wrap { max-width: 1000px; margin: 0 auto; padding: 64px 24px; }
    .subscribe-header { text-align: center; margin-bottom: 48px; }
    .subscribe-header h1 { font-size: clamp(24px, 4vw, 38px); font-weight: 800; color: var(--navy); margin-bottom: 10px; }
    .subscribe-header p { font-size: 16px; color: var(--gray-600); }
    .subscribe-note { text-align: center; margin-top: 32px; font-size: 13px; color: var(--gray-400); }
    .price-card-btn { width: 100%; margin-top: 20px; padding: 12px; background: var(--blue); color: #fff; border: none; border-radius: var(--radius-sm); font-size: 15px; font-weight: 600; cursor: pointer; font-family: Inter,sans-serif; transition: background .15s; }
    .price-card-btn:hover { background: var(--blue-light); }
    .price-card-btn.secondary { background: var(--gray-100); color: var(--navy); border: 1.5px solid var(--gray-200); }
    .price-card-btn.secondary:hover { background: var(--gray-200); }

    /* AUTH FOOTER */
    .auth-footer { text-align:center; padding:20px 24px; font-size:12px; color:var(--gray-400); border-top:1px solid var(--gray-100); background:#fff; margin-top:40px; }
    .auth-footer a { color:var(--gray-400); text-decoration:none; margin:0 8px; cursor:pointer; }
    .auth-footer a:hover { color:var(--blue); text-decoration:underline; }

    /* VIEWER PAGE */
    .viewer-wrap { max-width:900px; margin:0 auto; padding:40px 24px; }
    .viewer-back { display:inline-flex; align-items:center; gap:6px; color:var(--blue); font-size:14px; font-weight:600; cursor:pointer; margin-bottom:20px; background:none; border:none; font-family:'Inter',sans-serif; padding:0; }
    .viewer-back:hover { text-decoration:underline; }
    .viewer-meta { font-size:13px; color:var(--gray-400); margin-bottom:20px; }

    /* TRUST PAGES */
    .trust-wrap { max-width:760px; margin:0 auto; padding:48px 24px; }
    .trust-wrap h1 { font-size:28px; font-weight:800; color:var(--navy); margin-bottom:6px; }
    .trust-date { font-size:13px; color:var(--gray-400); margin-bottom:36px; }
    .trust-wrap h2 { font-size:18px; font-weight:700; color:var(--navy); margin:28px 0 10px; }
    .trust-wrap p, .trust-wrap li { font-size:14px; color:var(--gray-600); line-height:1.8; margin-bottom:12px; }
    .trust-wrap ul { padding-left:20px; }
    .trust-back { display:inline-flex; align-items:center; gap:6px; color:var(--blue); font-size:14px; font-weight:600; cursor:pointer; margin-bottom:28px; background:none; border:none; font-family:'Inter',sans-serif; padding:0; }
    .trust-back:hover { text-decoration:underline; }

    /* SETTINGS PAGE */
    .settings-section { background:#fff; border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--gray-200); padding:28px; margin-bottom:20px; }
    .settings-section-title { font-size:15px; font-weight:700; color:var(--navy); margin-bottom:18px; padding-bottom:12px; border-bottom:1px solid var(--gray-100); }
    .settings-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media(max-width:600px) { .settings-row { grid-template-columns:1fr; } }
    .page-title-bar { display:flex; align-items:center; gap:12px; margin-bottom:24px; }
    .page-back-btn { background:none; border:none; color:var(--blue); font-size:14px; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; padding:0; }
    .page-back-btn:hover { text-decoration:underline; }

    /* TEAM PAGE */
    .team-member-row { display:flex; align-items:center; justify-content:space-between; padding:14px 0; border-bottom:1px solid var(--gray-100); gap:12px; flex-wrap:wrap; }
    .team-member-row:last-child { border-bottom:none; }
    .member-info { display:flex; align-items:center; gap:12px; }
    .member-avatar { width:38px; height:38px; border-radius:50%; background:var(--blue); color:#fff; font-size:14px; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .member-name { font-size:14px; font-weight:600; color:var(--navy); }
    .member-email { font-size:12px; color:var(--gray-400); margin-top:2px; }
    .member-role-badge { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; padding:3px 9px; border-radius:99px; }
    .role-owner { background:#eff6ff; color:var(--blue); }
    .role-admin { background:#f0fdf4; color:var(--green); }
    .role-member { background:var(--gray-100); color:var(--gray-600); }
    .member-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn-sm { font-size:12px; font-weight:600; padding:5px 12px; border-radius:6px; cursor:pointer; border:1px solid var(--gray-200); background:#fff; color:var(--gray-700); font-family:'Inter',sans-serif; transition:all .15s; }
    .btn-sm:hover { background:var(--gray-100); }
    .btn-sm-danger { border-color:#fca5a5; color:#dc2626; }
    .btn-sm-danger:hover { background:#fef2f2; border-color:#dc2626; }
  </style>
</head>
<body>

<!-- Auth-init loader: covers flash of wrong page during session check on refresh -->
<div id="page-loader"><div class="pl-spin"></div></div>

<!-- NAV -->
<nav>
  <div class="nav-inner">
    <div class="nav-logo" onclick="showPage('landing')">RenewalScan<span>AI</span></div>
    <div class="nav-links" id="nav-public">
      <button class="nav-link" onclick="showPage('landing')">Home</button>
      <button class="nav-link" onclick="showPage('why')">Why Use Us</button>
      <button class="nav-link" onclick="showPage('subscribe')">Pricing</button>
      <button class="nav-btn" onclick="showPage('login')">Sign In</button>
      <button class="nav-btn" onclick="showPage('signup')">Sign Up</button>
    </div>
    <div class="nav-user" id="nav-private" style="display:none">
      <div class="nav-user-chip">
        <div class="nav-user-avatar" id="nav-avatar"></div>
        <span class="nav-user-name" id="nav-name"></span>
      </div>
      <button class="nav-link" onclick="showPage('dashboard')">Dashboard</button>
      <button class="nav-link" onclick="showPage('compare')">Renewals</button>
      <button class="nav-link" onclick="showPage('team')">Team</button>
      <button class="nav-link" onclick="showPage('settings')">Settings</button>
      <button class="nav-signout" onclick="doSignOut()">Sign out</button>
    </div>
  </div>
</nav>
<div class="toast" id="toast">&#10003; HTML copied — paste into Gmail or Outlook</div>
<div class="update-bar" id="update-bar">
  <span>&#8593; A new version is available</span>
  <button class="update-bar-btn" onclick="location.reload()">Refresh now</button>
  <button class="update-bar-dismiss" onclick="g('update-bar').classList.remove('show')" title="Dismiss">&#x2715;</button>
</div>

<!-- ═══════════════════════════════
     LANDING
═══════════════════════════════ -->
<div class="page active" id="page-landing">
  <div class="hero">
    <div class="hero-inner">
      <div class="hero-badge">AI-Powered for Insurance Advisors</div>
      <h1>Stop Spending Hours on <span>Renewal Documents</span></h1>
      <p>AI-powered comparison in 90 seconds. Professional breakdown, email-ready in one click.</p>
      <div class="hero-cta">
        <button class="btn-primary" onclick="showPage('signup')">Get Started Free</button>
        <button class="btn-outline" onclick="showPage('login')">Sign In</button>
      </div>
      <p style="margin-top:16px"><button onclick="showPage('why')" style="background:none;border:none;color:rgba(255,255,255,.7);font-size:14px;cursor:pointer;text-decoration:underline;font-family:Inter,sans-serif;padding:0">Why should I use this? &rarr;</button></p>
      <div class="hero-stats">
        <div class="stat"><div class="stat-num">90 sec</div><div class="stat-label">Avg comparison time</div></div>
        <div class="stat"><div class="stat-num">Zero</div><div class="stat-label">Manual work</div></div>
        <div class="stat"><div class="stat-num">100%</div><div class="stat-label">Email-ready output</div></div>
      </div>
    </div>
  </div>

  <section class="content-section">
    <h2 class="section-title">Everything you need</h2>
    <p class="section-sub">From PDF upload to client-ready email in minutes</p>
    <div class="cards">
      <div class="card"><div class="card-icon">&#128196;</div><h3>Upload Any PDF</h3><p>Drop in the old and new policy documents. AI reads and extracts all premium and cover data automatically.</p></div>
      <div class="card"><div class="card-icon">&#129302;</div><h3>AI Analysis</h3><p>Compares every line item — premiums, sums insured, fees, Sasria — and shows exactly what changed and by how much.</p></div>
      <div class="card"><div class="card-icon">&#128231;</div><h3>Copy to Email</h3><p>One click copies a professionally formatted table. Paste directly into Gmail or Outlook — it renders perfectly.</p></div>
    </div>
  </section>

  <section class="content-section" style="padding-top:0">
    <h2 class="section-title">How it works</h2>
    <p class="section-sub">Three steps from PDF to client email</p>
    <div class="steps">
      <div class="step"><div class="step-num">1</div><h3>Upload</h3><p>Select your old and renewal policy PDFs</p></div>
      <div class="step"><div class="step-num">2</div><h3>Analyse</h3><p>AI compares every cover section and premium</p></div>
      <div class="step"><div class="step-num">3</div><h3>Send</h3><p>Copy the formatted table into your client email</p></div>
    </div>
  </section>

  <section style="background:var(--gray-50);padding:60px 24px">
    <div style="max-width:1100px;margin:0 auto">
      <h2 class="section-title">What brokers are saying</h2>
      <p class="section-sub">Used by brokers across South Africa</p>
      <div class="testimonials-grid">
        <div class="testimonial-card">
          <p class="testimonial-text">&ldquo;RenewalScan AI cut my renewal admin time by 75%. I handle twice the clients with the same effort.&rdquo;</p>
          <div class="testimonial-author">Sarah M. &mdash; Independent Broker, Johannesburg</div>
        </div>
        <div class="testimonial-card">
          <p class="testimonial-text">&ldquo;My clients are impressed by how professional the renewal breakdown looks. It&rsquo;s become part of every renewal conversation.&rdquo;</p>
          <div class="testimonial-author">David K. &mdash; Financial Advisor, Cape Town</div>
        </div>
        <div class="testimonial-card">
          <p class="testimonial-text">&ldquo;I used to dread renewal season. Now I process 20 renewals in the time it used to take me to do 5. Genuinely game-changing.&rdquo;</p>
          <div class="testimonial-author">Priya N. &mdash; Short-Term Insurance Broker, Durban</div>
        </div>
      </div>
    </div>
  </section>

  <section class="content-section" style="padding-top:60px" id="pricing-section">
    <h2 class="section-title">Simple pricing</h2>
    <p class="section-sub">Choose the plan that fits your practice</p>
    <div class="pricing-grid">
      <div class="price-card">
        <div class="price-name">Starter</div>
        <div class="price-amount">R699<span class="price-period">/mo</span></div>
        <div class="price-limit">25 comparisons &middot; 1 user</div>
        <ul class="price-features"><li>Full AI comparison</li><li>Email-ready output</li><li>Usage dashboard</li><li>Email support</li></ul>
        <button class="price-card-btn" onclick="showPage('signup')">Get Started</button>
      </div>
      <div class="price-card featured">
        <div class="price-badge">Most Popular</div>
        <div class="price-name">Professional</div>
        <div class="price-amount">R1,999<span class="price-period">/mo</span></div>
        <div class="price-limit">75 comparisons &middot; 3 users</div>
        <ul class="price-features"><li>Everything in Starter</li><li>Admin can invite team members</li><li>Email support</li></ul>
        <button class="price-card-btn" onclick="showPage('signup')">Get Started</button>
      </div>
      <div class="price-card">
        <div class="price-name">Business</div>
        <div class="price-amount">R4,499<span class="price-period">/mo</span></div>
        <div class="price-limit">200 comparisons &middot; 8 users</div>
        <ul class="price-features"><li>Everything in Professional</li><li>Priority support</li></ul>
        <button class="price-card-btn" onclick="showPage('signup')">Get Started</button>
      </div>
      <div class="price-card">
        <div class="price-name">Enterprise</div>
        <div class="price-amount">R9,999<span class="price-period">/mo</span></div>
        <div class="price-limit">500 comparisons &middot; 20 users</div>
        <ul class="price-features"><li>Everything in Business</li><li>Dedicated account manager</li></ul>
        <a href="mailto:support@taskautomateai.co.za?subject=Enterprise Plan Enquiry" class="price-card-btn secondary" style="display:block;text-align:center;text-decoration:none;box-sizing:border-box">Contact Us</a>
      </div>
    </div>
  </section>

  <section class="content-section" style="background:var(--gray-50);max-width:100%;padding:60px 24px" id="faq-section">
    <div style="max-width:1100px;margin:0 auto">
      <h2 class="section-title">Frequently asked questions</h2>
      <p class="section-sub" style="margin-bottom:32px">Everything you need to know</p>
      <div class="faq-list">
        <div class="faq-item">
          <button class="faq-q" onclick="toggleFaq(this)">Is my data secure? <span class="faq-arrow">&#9660;</span></button>
          <div class="faq-a">Policy documents are never stored on our servers. Only the extracted text is sent for AI processing and discarded immediately after. All data is transmitted over HTTPS with strict security headers.</div>
        </div>
        <div class="faq-item">
          <button class="faq-q" onclick="toggleFaq(this)">What file types are supported? <span class="faq-arrow">&#9660;</span></button>
          <div class="faq-a">PDF only. Password-protected PDFs are supported &mdash; you can enter the password before uploading. Scanned PDFs with selectable text also work well.</div>
        </div>
        <div class="faq-item">
          <button class="faq-q" onclick="toggleFaq(this)">How accurate is the AI? <span class="faq-arrow">&#9660;</span></button>
          <div class="faq-a">Accuracy is very high for structured policy documents. The AI compares every premium, sum insured, Sasria levy, intermediary fee, and VAS item. We recommend verifying totals against original documents before client delivery.</div>
        </div>
        <div class="faq-item">
          <button class="faq-q" onclick="toggleFaq(this)">Can I cancel anytime? <span class="faq-arrow">&#9660;</span></button>
          <div class="faq-a">Yes. No lock-in contracts. Cancel at any time by emailing support@taskautomateai.co.za. Your access continues until the end of your current billing period.</div>
        </div>
        <div class="faq-item">
          <button class="faq-q" onclick="toggleFaq(this)">Is this POPIA compliant? <span class="faq-arrow">&#9660;</span></button>
          <div class="faq-a">Yes. No personal client data is stored on our servers. Policy text is processed in-transit and immediately discarded. Your comparison history is stored only in your own browser. See our Privacy Policy for full details.</div>
        </div>
      </div>
    </div>
  </section>

  <footer><span>&copy; 2026 RenewalScan AI &mdash; <a href="https://TaskAutomateAI.co.za" target="_blank" style="color:inherit;text-decoration:underline;">TaskAutomateAI</a> &nbsp;&middot;&nbsp; <span class="app-ver"></span></span></footer>
</div>

<!-- ═══════════════════════════════
     WHY USE US
═══════════════════════════════ -->
<div class="page" id="page-why">
  <div class="why-hero">
    <div class="hero-inner">
      <div class="hero-badge">Built for South African Insurance Brokers</div>
      <h1>Stop spending 30&ndash;60 minutes<br>on every renewal</h1>
      <p>RenewalScan AI does in 90 seconds what takes a broker an hour &mdash; and the output is already formatted for your client email.</p>
      <button class="btn-primary" onclick="showPage('signup')" style="font-size:16px;padding:14px 32px">Get Started Free &rarr;</button>
    </div>
  </div>

  <section class="content-section">
    <h2 class="section-title">Why brokers switch to RenewalScan AI</h2>
    <p class="section-sub">The renewal process hasn&rsquo;t changed in 20 years. We changed it.</p>
    <div class="cards">
      <div class="card">
        <div class="card-icon">&#9200;</div>
        <h3>30&ndash;60 minutes saved per renewal</h3>
        <p>Manual comparison means opening both documents, reading every line, spotting what changed, then formatting a client-ready summary. RenewalScan extracts, compares, and formats it in under 2 minutes.</p>
      </div>
      <div class="card">
        <div class="card-icon">&#128200;</div>
        <h3>More capacity for new clients</h3>
        <p>At 20 renewals a month, that&rsquo;s up to 20 hours of admin time returned to your practice every month. Hours you can spend acquiring new clients, building relationships, and growing your book.</p>
      </div>
      <div class="card">
        <div class="card-icon">&#10003;</div>
        <h3>AI catches what humans miss</h3>
        <p>Every premium, sum insured, Sasria levy, intermediary fee, and VAS item is checked line by line. Human review under time pressure misses things. AI doesn&rsquo;t.</p>
      </div>
      <div class="card">
        <div class="card-icon">&#128231;</div>
        <h3>Professional output, zero formatting</h3>
        <p>One click copies a formatted comparison table directly into Gmail or Outlook. Your client gets a clear, professional breakdown &mdash; without you spending another 15 minutes on formatting.</p>
      </div>
    </div>
  </section>

  <div class="quotescan-banner">
    <h3>Also comparing quotes for new clients?</h3>
    <p>QuoteScan AI compares insurance quotes the same way &mdash; built for the same brokers, same workflow.</p>
    <a href="#" class="btn-outline-white">Visit QuoteScan AI &rarr;</a>
  </div>

  <div class="why-cta-strip">
    <h2>Ready to save hours every week?</h2>
    <p>Join brokers who&rsquo;ve cut renewal admin time by over 75%.</p>
    <button class="btn-primary" onclick="showPage('signup')" style="font-size:15px;padding:13px 30px">Get Started Free &rarr;</button>
  </div>

  <footer><span>&copy; 2026 RenewalScan AI &mdash; <a href="https://TaskAutomateAI.co.za" target="_blank" style="color:inherit;text-decoration:underline;">TaskAutomateAI</a> &nbsp;&middot;&nbsp; <span class="app-ver"></span></span></footer>
</div>

<!-- ═══════════════════════════════
     SUBSCRIBE
═══════════════════════════════ -->
<div class="page" id="page-subscribe">
  <div class="subscribe-wrap">
    <div id="subscribe-banner" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#dc2626;border-radius:8px;padding:12px 16px;margin-bottom:20px;font-size:14px;font-weight:600;text-align:center"></div>
    <div class="subscribe-header">
      <h1>Choose your plan</h1>
      <p>Cancel anytime. No lock-in contracts. All plans include full AI comparison and email-ready output.</p>
    </div>
    <div class="pricing-grid">
      <div class="price-card">
        <div class="price-name">Starter</div>
        <div class="price-amount">R699<span class="price-period">/mo</span></div>
        <div class="price-limit">25 comparisons &middot; 1 user</div>
        <ul class="price-features">
          <li>Full AI comparison</li>
          <li>Email-ready output</li>
          <li>Usage dashboard</li>
          <li>Email support</li>
        </ul>
        <button class="price-card-btn" onclick="showPage('signup')">Get Started</button>
      </div>
      <div class="price-card featured">
        <div class="price-badge">Most Popular</div>
        <div class="price-name">Professional</div>
        <div class="price-amount">R1,999<span class="price-period">/mo</span></div>
        <div class="price-limit">75 comparisons &middot; 3 users</div>
        <ul class="price-features">
          <li>Everything in Starter</li>
          <li>Admin can invite team members</li>
          <li>Email support</li>
        </ul>
        <button class="price-card-btn" onclick="showPage('signup')">Get Started</button>
      </div>
      <div class="price-card">
        <div class="price-name">Business</div>
        <div class="price-amount">R4,499<span class="price-period">/mo</span></div>
        <div class="price-limit">200 comparisons &middot; 8 users</div>
        <ul class="price-features">
          <li>Everything in Professional</li>
          <li>Priority support</li>
        </ul>
        <button class="price-card-btn" onclick="showPage('signup')">Get Started</button>
      </div>
      <div class="price-card">
        <div class="price-name">Enterprise</div>
        <div class="price-amount">R9,999<span class="price-period">/mo</span></div>
        <div class="price-limit">500 comparisons &middot; 20 users</div>
        <ul class="price-features">
          <li>Everything in Business</li>
          <li>Dedicated account manager</li>
        </ul>
        <a href="mailto:support@taskautomateai.co.za?subject=Enterprise Plan Enquiry" class="price-card-btn secondary" style="display:block;text-align:center;text-decoration:none;box-sizing:border-box">Contact Us</a>
      </div>
    </div>
    <p class="subscribe-note">Plans activate immediately. Early subscribers lock in current pricing. Questions? <a href="mailto:support@taskautomateai.co.za" style="color:inherit;text-decoration:underline">Contact us</a></p>
  </div>
  <footer><span>&copy; 2026 RenewalScan AI &mdash; <a href="https://TaskAutomateAI.co.za" target="_blank" style="color:inherit;text-decoration:underline;">TaskAutomateAI</a> &nbsp;&middot;&nbsp; <span class="app-ver"></span></span></footer>
</div>

<!-- ═══════════════════════════════
     LOGIN
═══════════════════════════════ -->
<div class="page page-auth" id="page-login">
  <div class="auth-left">
    <div class="auth-left-logo">RenewalScan<span>AI</span></div>
    <h2>Compare policies in seconds</h2>
    <p>The fastest way to analyse policy renewals and present clear breakdowns to your clients.</p>
    <div class="auth-features">
      <div class="auth-feature">
        <div class="auth-feature-icon">&#9889;</div>
        <div class="auth-feature-text"><strong>Instant AI analysis</strong><span>Full premium breakdown in under 2 minutes</span></div>
      </div>
      <div class="auth-feature">
        <div class="auth-feature-icon">&#128203;</div>
        <div class="auth-feature-text"><strong>Copy-ready for email</strong><span>Paste directly into Gmail or Outlook</span></div>
      </div>
      <div class="auth-feature">
        <div class="auth-feature-icon">&#128274;</div>
        <div class="auth-feature-text"><strong>Secure &amp; private</strong><span>Documents processed and discarded immediately</span></div>
      </div>
    </div>
  </div>
  <div class="auth-right">
    <div class="auth-form-wrap">
      <div class="auth-form-title">Welcome back</div>
      <div class="auth-form-sub">Sign in to your account to continue</div>
      <div class="msg-error" id="err-login"></div>
      <div class="form-group"><label>Email address</label><input type="email" id="l-email" placeholder="you@example.com" onkeydown="if(event.key==='Enter')doLoginEmail()" /></div>
      <div class="form-group"><label>Password</label><input type="password" id="l-pass" placeholder="Your password" onkeydown="if(event.key==='Enter')doLoginEmail()" /></div>
      <button class="btn-full" id="btn-login" onclick="doLoginEmail()">Sign in</button>
      <div class="auth-link" style="margin-top:12px"><a onclick="doForgotPassword()">Forgot password?</a></div>
      <div class="auth-link">Don't have an account? <a onclick="showPage('signup')">Sign up free</a></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     SIGN UP
═══════════════════════════════ -->
<div class="page page-auth" id="page-signup">
  <div class="auth-left">
    <div class="auth-left-logo">RenewalScan<span>AI</span></div>
    <h2>Join advisors saving hours every week</h2>
    <p>Stop manually comparing renewal documents. Let AI do the heavy lifting so you can focus on your clients.</p>
    <div class="auth-features">
      <div class="auth-feature">
        <div class="auth-feature-icon">&#128200;</div>
        <div class="auth-feature-text"><strong>Track monthly usage</strong><span>Dashboard shows your comparison activity</span></div>
      </div>
      <div class="auth-feature">
        <div class="auth-feature-icon">&#127775;</div>
        <div class="auth-feature-text"><strong>Professional output</strong><span>Polished tables your clients will trust</span></div>
      </div>
      <div class="auth-feature">
        <div class="auth-feature-icon">&#128640;</div>
        <div class="auth-feature-text"><strong>Up and running in minutes</strong><span>No training required &mdash; just upload and get results</span></div>
      </div>
    </div>
  </div>
  <div class="auth-right">
    <div class="auth-form-wrap">
      <div class="auth-form-title">Create your account</div>
      <div class="auth-form-sub">Start comparing policies today &mdash; free to try</div>
      <div class="msg-error" id="err-signup"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group" style="margin-bottom:0"><label>First name</label><input type="text" id="s-fname" placeholder="John" /></div>
        <div class="form-group" style="margin-bottom:0"><label>Surname</label><input type="text" id="s-lname" placeholder="Smith" /></div>
      </div>
      <div class="form-group"><label>Email address</label><input type="email" id="s-email" placeholder="you@example.com" /></div>
      <div class="form-group"><label>Password</label><input type="password" id="s-pass" placeholder="At least 8 characters" /></div>
      <div class="form-group"><label>Confirm password</label><input type="password" id="s-pass2" placeholder="Repeat your password" onkeydown="if(event.key==='Enter')doSignUp()" /></div>
      <div class="form-group" style="margin-bottom:4px">
        <label style="display:flex;align-items:flex-start;gap:10px;font-size:13px;color:var(--gray-600);cursor:pointer;font-weight:400">
          <input type="checkbox" id="consent-popia" style="margin-top:3px;flex-shrink:0">
          <span>I consent to the processing of my personal data, including sending policy document text to Anthropic's AI API for analysis, as described in the <a onclick="showPage('privacy')" style="color:var(--blue)">Privacy Policy</a>.</span>
        </label>
      </div>
      <button class="btn-full" id="btn-signup" onclick="doSignUp()">Create account</button>
      <div class="auth-link" style="font-size:12px;color:var(--gray-400);line-height:1.6;margin-top:14px">
        By creating an account you agree to our <a onclick="showPage('terms')">Terms of Service</a> and <a onclick="showPage('privacy')">Privacy Policy</a>.
      </div>
      <div class="auth-link">Already have an account? <a onclick="showPage('login')">Sign in</a></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     VERIFY EMAIL
═══════════════════════════════ -->
<div class="page page-auth" id="page-verify">
  <div class="auth-left">
    <div class="auth-left-logo">RenewalScan<span>AI</span></div>
    <h2>Almost there&hellip;</h2>
    <p>We just need to confirm your email address before you can start comparing policies.</p>
    <div class="auth-features">
      <div class="auth-feature">
        <div class="auth-feature-icon">&#128274;</div>
        <div class="auth-feature-text"><strong>Why we verify</strong><span>Keeps your account secure and prevents unauthorised access</span></div>
      </div>
      <div class="auth-feature">
        <div class="auth-feature-icon">&#9201;</div>
        <div class="auth-feature-text"><strong>Takes 30 seconds</strong><span>Check your inbox and click the link we sent you</span></div>
      </div>
    </div>
  </div>
  <div class="auth-right">
    <div class="auth-form-wrap" style="text-align:center">
      <div class="verify-icon-wrap">&#128231;</div>
      <div class="auth-form-title">Check your email</div>
      <p style="font-size:14px;color:var(--gray-600);margin:10px 0 28px;line-height:1.8">We sent a verification link to<br><strong id="verify-email" style="color:var(--navy)"></strong><br>Click the link to activate your account.</p>
      <div class="msg-error" id="err-verify"></div>
      <div class="msg-success" id="ok-verify"></div>
      <button class="btn-full" onclick="doCheckVerify()" id="btn-check-verify">I've verified my email</button>
      <button class="btn-secondary-full" onclick="doResendVerify()">Resend verification email</button>
      <div class="auth-link"><a onclick="doSignOut();showPage('login')">Sign out</a></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     DASHBOARD
═══════════════════════════════ -->
<div class="page" id="page-dashboard">
  <div class="dash-wrap">
    <div class="dash-welcome">Welcome back, <span id="dash-name">there</span> &#128075;</div>
    <div class="dash-sub">Here's your activity this month</div>
    <div class="dash-grid">
      <div class="dash-card">
        <div class="dash-label">Comparisons this month</div>
        <div class="dash-value" id="dash-count">0</div>
        <div class="dash-card-sub">of <span id="dash-limit">&#8212;</span> included in your plan</div>
        <div class="usage-bar-wrap"><div class="usage-bar" id="dash-bar" style="width:0%"></div></div>
        <div id="dash-limit-warning" style="display:none;font-size:12px;color:var(--red);margin-top:8px;font-weight:600"></div>
      </div>
      <div class="dash-card">
        <div class="dash-label">Current plan</div>
        <div class="dash-plan-name" id="dash-tier">Starter</div>
        <div class="dash-active-badge"><div class="dash-active-dot"></div>Active</div>
        <div class="dash-plan-limit" id="dash-plan-limit"></div>
        <a class="dash-upgrade-link" onclick="showPage('subscribe')">View plans &rarr;</a>
      </div>
    </div>
    <div class="dash-cta">
      <div><h2>Ready to run a renewal comparison?</h2><p>Upload the old and new policy PDFs and get a full breakdown in minutes</p></div>
      <button class="btn-white" onclick="showPage('compare')">Start Renewal Comparison &#8594;</button>
    </div>

    <div class="msg-error" id="err-dashboard" style="margin-bottom:16px"></div>

    <div style="margin-top:28px">
      <div class="dash-section-title">Renewals Processed <span id="dash-history-count"></span><button id="btn-clear-history" onclick="clearAllHistory()" style="display:none;margin-left:auto;background:none;border:1px solid var(--gray-200);color:var(--gray-600);font-size:12px;font-weight:500;padding:4px 12px;border-radius:6px;cursor:pointer;font-family:Inter,sans-serif">Clear all</button></div>
      <div style="background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--gray-200);overflow:hidden">
        <div style="padding:10px 14px;border-bottom:1px solid var(--gray-100)">
          <input type="text" id="history-search" placeholder="&#128269; Search by client name…" oninput="filterHistory(this.value)" style="width:100%;box-sizing:border-box;padding:7px 12px;font-size:13px;font-family:Inter,sans-serif;border:1px solid var(--gray-200);border-radius:6px;outline:none;color:var(--navy)" />
        </div>
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:var(--navy)">
              <th style="padding:11px 14px;text-align:left;font-size:12px;font-weight:600;color:#fff;text-transform:uppercase;letter-spacing:.5px">Client Name</th>
              <th style="padding:11px 14px;text-align:left;font-size:12px;font-weight:600;color:#fff;text-transform:uppercase;letter-spacing:.5px">Date</th>
              <th style="padding:11px 14px;text-align:right;font-size:12px;font-weight:600;color:#fff;text-transform:uppercase;letter-spacing:.5px">Duration</th>
              <th style="padding:11px 14px;text-align:right;font-size:12px;font-weight:600;color:#fff;text-transform:uppercase;letter-spacing:.5px">Change</th>
              <th style="padding:11px 14px;text-align:right;font-size:12px;font-weight:600;color:#fff;text-transform:uppercase;letter-spacing:.5px">Actions</th>
            </tr>
          </thead>
          <tbody id="renewals-tbody">
            <tr><td colspan="5" style="text-align:center;padding:20px;color:var(--gray-400);font-style:italic">No comparisons yet.</td></tr>
          </tbody>
        </table>
      </div>
      <p style="margin-top:10px;font-size:12px;color:var(--gray-400);display:flex;align-items:center;gap:6px">
        <span>&#128274;</span> History is saved on this device only — it won't appear on other browsers or devices. To keep a permanent record, open a comparison and use the copy or email option before clearing history.
      </p>
    </div>
    <div class="auth-footer">
      <a onclick="showPage('privacy')">Privacy Policy</a>
      <a onclick="showPage('terms')">Terms of Service</a>
      <a onclick="showPage('support')">Support</a>
      &copy; 2026 RenewalScan AI &mdash; <a href="https://TaskAutomateAI.co.za" target="_blank" style="color:inherit;text-decoration:none">TaskAutomateAI</a> &nbsp;&middot;&nbsp; <span class="app-ver"></span>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     COMPARE
═══════════════════════════════ -->
<div class="page" id="page-compare">
  <div class="compare-wrap">
    <div class="compare-title">Renewal Comparison</div>
    <div class="compare-sub">Upload the old and new renewal policy PDFs to begin your analysis</div>

    <div class="progress-steps">
      <div class="ps-step"><div class="ps-circle" id="ps1">1</div><div class="ps-label" id="pl1">Upload &amp; Extract</div></div>
      <div class="ps-connector" id="pc1"></div>
      <div class="ps-step"><div class="ps-circle" id="ps2">2</div><div class="ps-label" id="pl2">AI Analysis</div></div>
      <div class="ps-connector" id="pc2"></div>
      <div class="ps-step"><div class="ps-circle" id="ps3">3</div><div class="ps-label" id="pl3">Results</div></div>
    </div>

    <div id="upload-panel">
      <div class="msg-error" id="err-compare" role="alert" aria-live="assertive"></div>
      <button id="btn-retry" onclick="retryComparison()" style="display:none;margin-top:10px;padding:10px 22px;background:var(--gray-100);color:var(--navy);border:1.5px solid var(--gray-200);border-radius:var(--radius-sm);font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;transition:background .15s" onmouseover="this.style.background='var(--gray-200)'" onmouseout="this.style.background='var(--gray-100)'">&#8635; Try Again</button>
      <div class="upload-grid">
        <div>
          <label style="font-size:13px;font-weight:600;color:var(--navy);display:block;margin-bottom:8px">Old / Existing Policy</label>
          <div class="upload-zone" id="zone-old" ondragover="onDragOver(event,'old')" ondragleave="onDragLeave('old')" ondrop="onDrop(event,'old')">
            <input class="upload-input" type="file" id="file-old" accept=".pdf" onchange="onFileSelect('old')" />
            <div class="upload-icon">&#128196;</div>
            <div class="upload-label-text">Old Policy PDF</div>
            <div class="upload-hint-text">Click to browse or drag &amp; drop</div>
            <div class="upload-filename" id="fn-old"></div>
          </div>
          <div style="margin-top:10px;position:relative" id="pass-wrap-old">
            <div id="pass-trigger-old" onclick="togglePassDropdown('old')" style="cursor:pointer;font-size:13px;padding:9px 12px;border:1.5px solid var(--gray-200);border-radius:var(--radius-sm);width:100%;font-family:Inter,sans-serif;color:var(--gray-400);background:#fff;display:flex;align-items:center;justify-content:space-between;user-select:none">
              <span id="pass-trigger-label-old">PDF password (if protected)</span>
              <span style="font-size:10px;color:var(--gray-400)">▼</span>
            </div>
            <div id="pass-dropdown-old" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid var(--blue);border-radius:var(--radius-sm);box-shadow:0 4px 16px rgba(15,39,68,.12);z-index:200;overflow:hidden">
              <div id="pass-saved-list-old"></div>
              <div style="padding:8px 8px 4px">
                <input type="password" id="pass-old" placeholder="Enter password…" style="font-size:13px;padding:8px 10px;border:1.5px solid var(--gray-200);border-radius:6px;width:100%;font-family:Inter,sans-serif;outline:none;color:var(--gray-700)" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--gray-200)'" oninput="onPassInput('old')" />
              </div>
              <div style="padding:0 8px 8px">
                <label id="save-pass-label-old" style="display:none;align-items:center;gap:6px;font-size:12px;color:var(--gray-500);cursor:pointer;user-select:none"><input type="checkbox" id="save-pass-check-old" style="cursor:pointer;accent-color:var(--blue)"> Save this password for future use</label>
              </div>
            </div>
          </div>
        </div>
        <div>
          <label style="font-size:13px;font-weight:600;color:var(--navy);display:block;margin-bottom:8px">New / Renewal Policy</label>
          <div class="upload-zone" id="zone-new" ondragover="onDragOver(event,'new')" ondragleave="onDragLeave('new')" ondrop="onDrop(event,'new')">
            <input class="upload-input" type="file" id="file-new" accept=".pdf" onchange="onFileSelect('new')" />
            <div class="upload-icon">&#128196;</div>
            <div class="upload-label-text">New Policy PDF</div>
            <div class="upload-hint-text">Click to browse or drag &amp; drop</div>
            <div class="upload-filename" id="fn-new"></div>
          </div>
          <div style="margin-top:10px;position:relative" id="pass-wrap-new">
            <div id="pass-trigger-new" onclick="togglePassDropdown('new')" style="cursor:pointer;font-size:13px;padding:9px 12px;border:1.5px solid var(--gray-200);border-radius:var(--radius-sm);width:100%;font-family:Inter,sans-serif;color:var(--gray-400);background:#fff;display:flex;align-items:center;justify-content:space-between;user-select:none">
              <span id="pass-trigger-label-new">PDF password (if protected)</span>
              <span style="font-size:10px;color:var(--gray-400)">▼</span>
            </div>
            <div id="pass-dropdown-new" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid var(--blue);border-radius:var(--radius-sm);box-shadow:0 4px 16px rgba(15,39,68,.12);z-index:200;overflow:hidden">
              <div id="pass-saved-list-new"></div>
              <div style="padding:8px 8px 4px">
                <input type="password" id="pass-new" placeholder="Enter password…" style="font-size:13px;padding:8px 10px;border:1.5px solid var(--gray-200);border-radius:6px;width:100%;font-family:Inter,sans-serif;outline:none;color:var(--gray-700)" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--gray-200)'" oninput="onPassInput('new')" />
              </div>
              <div style="padding:0 8px 8px">
                <label id="save-pass-label-new" style="display:none;align-items:center;gap:6px;font-size:12px;color:var(--gray-500);cursor:pointer;user-select:none"><input type="checkbox" id="save-pass-check-new" style="cursor:pointer;accent-color:var(--blue)"> Save this password for future use</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top:16px" id="notes-wrap">
        <label style="font-size:13px;font-weight:600;color:var(--navy);display:block;margin-bottom:6px">Additional Notes <span style="font-weight:400;color:var(--gray-400)">(optional)</span></label>
        <div id="note-templates-row" style="display:none;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px"></div>
        <div style="position:relative">
          <div id="notes-saved-list" style="display:none;position:absolute;bottom:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid var(--blue);border-radius:var(--radius-sm);box-shadow:0 4px 16px rgba(15,39,68,.12);z-index:200;max-height:200px;overflow-y:auto"></div>
          <textarea id="comparison-notes" placeholder="Type notes to include below the comparison in the email…" style="width:100%;font-size:13px;padding:10px 12px;border:1.5px solid var(--gray-200);border-radius:var(--radius-sm);font-family:Inter,sans-serif;color:var(--gray-700);resize:vertical;min-height:80px;outline:none;line-height:1.6" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--gray-200)'" oninput="renderSavedNotesList();toggleSaveNoteCheckbox();renderNoteTemplates()"></textarea>
        </div>
        <label id="save-note-label" style="display:none;align-items:center;gap:6px;font-size:12px;color:var(--gray-500);margin-top:6px;cursor:pointer;user-select:none"><input type="checkbox" id="save-note-check" style="cursor:pointer;accent-color:var(--blue)"> Save this note for future use</label>
      </div>
      <button class="btn-compare" id="btn-compare" onclick="runComparison()" disabled>Analyse Renewal</button>
    </div>

    <div class="processing" id="proc-panel">
      <div class="spinner"></div>
      <div class="proc-text" id="proc-text">Extracting text from PDFs...</div>
      <div class="proc-sub" id="proc-sub">Reading policy documents</div>
    </div>

    <div class="results" id="results-panel">
      <div class="results-hdr">
        <div class="results-title">Comparison Results</div>
        <div class="results-actions">
          <button class="btn-copy" id="btn-copy" onclick="doCopyHtml()">&#128203; Copy HTML for Email</button>
          <button class="btn-reset" id="btn-pdf" onclick="doPrintPdf()">&#11015; Download PDF</button>
          <button class="btn-reset" onclick="resetCompare()">&#8635; New Comparison</button>
        </div>
      </div>
      <div id="results-output"></div>
    </div>
    <div class="auth-footer">
      <a onclick="showPage('privacy')">Privacy Policy</a>
      <a onclick="showPage('terms')">Terms of Service</a>
      <a onclick="showPage('support')">Support</a>
      &copy; 2026 RenewalScan AI &mdash; <a href="https://TaskAutomateAI.co.za" target="_blank" style="color:inherit;text-decoration:none">TaskAutomateAI</a> &nbsp;&middot;&nbsp; <span class="app-ver"></span>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     VIEWER — Past Comparison Result
═══════════════════════════════ -->
<div class="page" id="page-viewer">
  <div class="viewer-wrap">
    <button class="viewer-back" onclick="showPage('dashboard')">&#8592; Back to Dashboard</button>
    <div class="viewer-meta" id="viewer-meta"></div>
    <div class="results-hdr" style="margin-bottom:20px">
      <div class="results-title">Comparison Results</div>
      <div class="results-actions">
        <button class="btn-copy" id="viewer-copy-btn" onclick="doCopyHtml('viewer-copy-btn')">&#128203; Copy HTML for Email</button>
        <button class="btn-reset" id="viewer-download-btn" onclick="viewerPrintPdf()">&#11015; Download PDF</button>
      </div>
    </div>
    <div id="viewer-results-output"></div>
    <div class="auth-footer">
      <a onclick="showPage('privacy')">Privacy Policy</a>
      <a onclick="showPage('terms')">Terms of Service</a>
      <a onclick="showPage('support')">Support</a>
      &copy; 2026 RenewalScan AI &mdash; <a href="https://TaskAutomateAI.co.za" target="_blank" style="color:inherit;text-decoration:none">TaskAutomateAI</a> &nbsp;&middot;&nbsp; <span class="app-ver"></span>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     PRIVACY POLICY
═══════════════════════════════ -->
<div class="page" id="page-privacy">
  <div class="trust-wrap">
    <button class="trust-back" onclick="history.back()">&#8592; Back</button>
    <h1>Privacy Policy</h1>
    <div class="trust-date">Last updated: February 2026</div>
    <p>RenewalScan AI ("we", "our", "us") is operated by TaskAutomateAI (Pty) Ltd. This policy explains what personal information we collect, why we collect it, how we use and protect it, and what rights you have over it. This policy is compliant with the Protection of Personal Information Act 4 of 2013 (POPIA/POPI Act).</p>

    <h2>1. Responsible Party &amp; Information Officer</h2>
    <p>The responsible party for your personal information is TaskAutomateAI (Pty) Ltd. For all privacy-related queries, requests, or complaints, contact our Information Officer at <a href="mailto:support@taskautomateai.co.za" style="color:var(--blue)">support@taskautomateai.co.za</a>.</p>

    <h2>2. Personal Information We Collect</h2>
    <ul>
      <li><strong>Account data:</strong> Your name, email address, and hashed password, stored securely on our servers.</li>
      <li><strong>Usage data:</strong> A count of comparisons you run, stored in our database under your user ID, to enforce your plan limits.</li>
      <li><strong>Session data:</strong> A session token stored in your browser to keep you signed in. Sessions expire after 30 days of inactivity and are deleted on logout.</li>
      <li><strong>Comparison history:</strong> The output of each policy comparison — including client name, date, and comparison result — stored in your browser's local storage only. This data is never transmitted to or stored on our servers.</li>
      <li><strong>Policy document text:</strong> Text extracted from PDFs you upload is sent to our AI processing API for analysis only. This text is not retained after processing is complete.</li>
      <li><strong>Trial usage identifiers:</strong> To track free trial usage, we store a one-way hashed (SHA-256) version of your IP address and a browser-generated anonymous device ID. Raw IP addresses are never stored on our servers.</li>
    </ul>

    <h2>3. Lawful Basis for Processing</h2>
    <p>We process your personal information on the following lawful grounds under POPIA:</p>
    <ul>
      <li><strong>Contractual necessity:</strong> To create and manage your account and deliver the RenewalScan AI service you have signed up for.</li>
      <li><strong>Consent:</strong> For the transmission of policy document text to our AI processing provider (Anthropic, Inc.) for AI analysis. You provide this consent at account registration.</li>
      <li><strong>Legitimate interest:</strong> To protect the integrity of our free trial system and prevent abuse, using hashed identifiers only.</li>
    </ul>

    <h2>4. How We Use Your Data</h2>
    <p>We use your personal information exclusively to provide the RenewalScan AI service: authenticating your account, enforcing your plan usage limits, and operating the comparison feature. We do not use your data for advertising, profiling, or any purpose beyond operating this service.</p>

    <h2>5. Data Sharing and Cross-Border Transfers</h2>
    <p>We do not sell, rent, or share your personal information with third parties for marketing purposes. Policy document text submitted for comparison is transmitted to Anthropic, Inc. (United States) via an encrypted API call for AI analysis only. Anthropic does not retain this content after processing. This constitutes a cross-border transfer under POPIA Section 72. By creating an account you consent to this transfer. You may review Anthropic's privacy policy at <a href="https://www.anthropic.com/privacy" target="_blank" rel="noopener" style="color:var(--blue)">anthropic.com/privacy</a>.</p>

    <h2>6. Data Retention</h2>
    <ul>
      <li><strong>Account data:</strong> Retained for as long as your account is active. Deleted within 30 days of an account deletion request.</li>
      <li><strong>Session tokens:</strong> Expire automatically after 30 days, or immediately on logout.</li>
      <li><strong>Hashed trial identifiers:</strong> Retained indefinitely to prevent free trial abuse. These cannot be used to identify you directly.</li>
      <li><strong>Comparison history:</strong> Stored only in your browser's local storage. Automatically capped at your 20 most recent comparisons. Cleared when you clear your browser data.</li>
      <li><strong>Policy document text:</strong> Not retained — discarded immediately after AI processing.</li>
    </ul>

    <h2>7. Your Rights Under POPIA</h2>
    <p>As a data subject under POPIA, you have the following rights:</p>
    <ul>
      <li><strong>Right of access:</strong> Request a copy of the personal information we hold about you.</li>
      <li><strong>Right to correction or deletion:</strong> Request that we correct inaccurate information or delete your personal information where we are no longer lawfully entitled to retain it.</li>
      <li><strong>Right to object:</strong> Object to the processing of your personal information in certain circumstances.</li>
      <li><strong>Right to data portability:</strong> Request an export of your account data in a structured format using the "Export My Data" feature in your account settings.</li>
      <li><strong>Right to delete your account:</strong> Delete your account and all associated personal information at any time from your account settings.</li>
      <li><strong>Right to lodge a complaint:</strong> If you believe we have violated POPIA, you may lodge a complaint with the Information Regulator of South Africa at <a href="https://www.inforegulator.org.za" target="_blank" rel="noopener" style="color:var(--blue)">inforegulator.org.za</a> or by email to <a href="mailto:inforeg@justice.gov.za" style="color:var(--blue)">inforeg@justice.gov.za</a>.</li>
    </ul>
    <p>To exercise any of the above rights, contact our Information Officer at <a href="mailto:support@taskautomateai.co.za" style="color:var(--blue)">support@taskautomateai.co.za</a>. We will respond within 30 days.</p>

    <h2>8. Security Safeguards</h2>
    <p>All data is transmitted over HTTPS (TLS encryption). Passwords are hashed using a salted SHA-256 key-stretching algorithm (5 000 iterations) and are never stored in plain text. Session tokens are cryptographically random. We maintain technical and organisational measures to protect personal information against unauthorised access, loss, damage, or destruction. Access to our database is restricted to authorised personnel only.</p>

    <h2>9. Data Breach Notification</h2>
    <p>In the event of a data breach that is likely to result in significant harm to you, we will notify the Information Regulator of South Africa and affected data subjects as required by POPIA Section 22, without undue delay and within the timeframes prescribed by law.</p>

    <h2>10. Cookies and Local Storage</h2>
    <p>We do not use tracking cookies. We use browser local storage to store your session token, comparison history, saved passwords (encrypted in-browser), and application preferences. This data remains on your device and is never transmitted to our servers except for the session token used for authentication.</p>

    <h2>11. Changes to This Policy</h2>
    <p>We may update this policy from time to time. The "Last updated" date at the top will reflect any changes. Continued use of the service after a policy update constitutes acceptance of the revised policy.</p>

    <h2>12. Contact</h2>
    <p>For any privacy-related requests or questions, contact our Information Officer: <a href="mailto:support@taskautomateai.co.za" style="color:var(--blue)">support@taskautomateai.co.za</a></p>
  </div>
</div>

<!-- ═══════════════════════════════
     TERMS OF SERVICE
═══════════════════════════════ -->
<div class="page" id="page-terms">
  <div class="trust-wrap">
    <button class="trust-back" onclick="history.back()">&#8592; Back</button>
    <h1>Terms of Service</h1>
    <div class="trust-date">Last updated: February 2026</div>
    <p>These Terms of Service ("Terms") govern your use of RenewalScan AI, operated by TaskAutomateAI. By creating an account or using this service, you agree to these Terms.</p>
    <h2>1. Permitted Use</h2>
    <p>RenewalScan AI is a B2B tool intended for use by licensed insurance brokers and financial advisors. You may use this service only for lawful professional purposes. You may not resell, sublicence, or provide access to the service to third parties without written permission.</p>
    <h2>2. Account Responsibility</h2>
    <p>You are responsible for maintaining the security of your account credentials. You are responsible for all activity that occurs under your account. Notify us immediately if you suspect unauthorised access.</p>
    <h2>3. Acceptable Use</h2>
    <p>You may not use RenewalScan AI to process documents you do not have lawful authority to access, to attempt to reverse-engineer the AI analysis, to upload malicious files, or to circumvent usage limits through automated means.</p>
    <h2>4. Service Availability</h2>
    <p>We aim to provide continuous availability but do not guarantee uninterrupted service. We may perform maintenance at any time. Planned downtime will be communicated where possible.</p>
    <h2>5. Limitation of Liability</h2>
    <p>RenewalScan AI is an analytical tool. The output of any comparison is for informational purposes and should not be relied upon as the sole basis for financial or insurance advice to clients. TaskAutomateAI accepts no liability for decisions made based on comparison output. To the maximum extent permitted by applicable law, our total liability to you for any claim arising from use of this service is limited to the fees you paid in the 30 days preceding the claim.</p>
    <h2>6. Intellectual Property</h2>
    <p>All software, design, and content in this service is owned by TaskAutomateAI. You retain ownership of any documents you upload.</p>
    <h2>7. Termination</h2>
    <p>We may suspend or terminate your account for material breach of these Terms. You may cancel your account at any time by contacting support.</p>
    <h2>8. Governing Law</h2>
    <p>These Terms are governed by the laws of South Africa. Disputes will be resolved in the courts of South Africa.</p>
    <h2>9. Contact</h2>
    <p>For questions about these Terms: <a href="mailto:support@taskautomateai.co.za" style="color:var(--blue)">support@taskautomateai.co.za</a></p>
  </div>
</div>

<!-- ═══════════════════════════════
     SUPPORT
═══════════════════════════════ -->
<div class="page" id="page-support">
  <div class="trust-wrap">
    <button class="trust-back" onclick="history.back()">&#8592; Back</button>
    <h1>Support &amp; Contact</h1>
    <div class="trust-date">We respond to all queries within 1 business day</div>
    <h2>Get in Touch</h2>
    <p>Email us at <a href="mailto:support@taskautomateai.co.za" style="color:var(--blue)">support@taskautomateai.co.za</a>. We respond within 1 business day (Monday&ndash;Friday, 08:00&ndash;17:00 SAST).</p>
    <h2>Frequently Asked Questions</h2>
    <p><strong>What file types are supported?</strong><br>RenewalScan AI accepts PDF files only. Both text-based and digitally generated PDFs work. Scanned image-only PDFs are not supported &mdash; the text must be extractable.</p>
    <p><strong>Are password-protected PDFs supported?</strong><br>Yes. Enter the PDF password in the field below the upload zone before running the comparison.</p>
    <p><strong>How long does a comparison take?</strong><br>Most comparisons complete in 30&ndash;90 seconds depending on document length and AI processing time.</p>
    <p><strong>Where is my comparison history stored?</strong><br>Your 20 most recent comparison results are stored in your browser's local storage, tied to your account. They persist across browser restarts but will be cleared if you clear your browser data.</p>
    <p><strong>What happens to the PDFs I upload?</strong><br>Only the extracted text from your PDFs is sent to our AI for analysis. The raw PDF files are never uploaded to our servers. Extracted text is not stored after processing.</p>
    <p><strong>I hit my comparison limit. What do I do?</strong><br>Visit the <a onclick="showPage('subscribe')" href="#" style="color:var(--blue)">Plans page</a> to choose a subscription, or email us at <a href="mailto:support@taskautomateai.co.za" style="color:var(--blue)">support@taskautomateai.co.za</a>. Upgrades take effect immediately.</p>
    <p><strong>Can I view a past comparison result?</strong><br>Yes &mdash; click the "View" button next to any comparison in your dashboard history to re-open the full result.</p>
    <h2>Billing</h2>
    <p>For billing queries, plan upgrades, or cancellations, email <a href="mailto:support@taskautomateai.co.za" style="color:var(--blue)">support@taskautomateai.co.za</a> with your account email address.</p>
  </div>
</div>

<!-- ═══════════════════════════════
     RESET PASSWORD
═══════════════════════════════ -->
<div class="page page-auth" id="page-reset-password">
  <div class="auth-left">
    <div class="auth-left-logo">RenewalScan<span>AI</span></div>
    <h2>Set a new password</h2>
    <p>Choose a strong password for your account. You'll use this to sign in from now on.</p>
    <div class="auth-features">
      <div class="auth-feature">
        <div class="auth-feature-icon">&#128274;</div>
        <div class="auth-feature-text"><strong>Secure by default</strong><span>Passwords are hashed and never stored in plain text</span></div>
      </div>
    </div>
  </div>
  <div class="auth-right">
    <div class="auth-form-wrap">
      <div class="auth-form-title">Reset your password</div>
      <div class="auth-form-sub">Enter your new password below</div>
      <div class="msg-error" id="err-reset"></div>
      <div class="msg-success" id="ok-reset"></div>
      <div class="form-group"><label>New password</label><input type="password" id="r-pass" placeholder="At least 8 characters" /></div>
      <div class="form-group"><label>Confirm password</label><input type="password" id="r-pass2" placeholder="Repeat new password" onkeydown="if(event.key==='Enter')doResetPassword()" /></div>
      <button class="btn-full" id="btn-reset-pass" onclick="doResetPassword()">Set new password</button>
      <div class="auth-link"><a onclick="showPage('login')">Back to sign in</a></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     ACCEPT INVITE
═══════════════════════════════ -->
<div class="page page-auth" id="page-accept-invite">
  <div class="auth-left">
    <div class="auth-left-logo">RenewalScan<span>AI</span></div>
    <h2>You've been invited</h2>
    <p>Accept your invitation to join a team on RenewalScan AI and access shared comparisons.</p>
    <div class="auth-features">
      <div class="auth-feature">
        <div class="auth-feature-icon">&#128101;</div>
        <div class="auth-feature-text"><strong>Team access</strong><span>Share your plan's comparison quota with your team</span></div>
      </div>
    </div>
  </div>
  <div class="auth-right">
    <div class="auth-form-wrap" style="text-align:center">
      <div class="verify-icon-wrap">&#128231;</div>
      <div class="auth-form-title">Team Invitation</div>
      <p style="font-size:14px;color:var(--gray-600);margin:10px 0 28px;line-height:1.8">You have been invited to join a team on RenewalScan AI.</p>
      <div class="msg-error" id="err-invite"></div>
      <div class="msg-success" id="ok-invite"></div>
      <div id="invite-login-prompt" style="display:none">
        <p style="font-size:13px;color:var(--gray-600);margin-bottom:16px">Sign in or create an account to accept this invitation.</p>
        <button class="btn-full" onclick="showPage('login')">Sign in</button>
        <button class="btn-secondary-full" onclick="showPage('signup')">Create account</button>
      </div>
      <div id="invite-accept-btn" style="display:none">
        <button class="btn-full" id="btn-accept-invite" onclick="doAcceptInvite()">Accept Invitation</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     SETTINGS
═══════════════════════════════ -->
<div class="page" id="page-settings">
  <div class="dash-wrap">
    <div class="page-title-bar">
      <button class="page-back-btn" onclick="showPage('dashboard')">&#8592; Back</button>
      <div class="dash-welcome" style="margin:0">Account Settings</div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Profile</div>
      <div class="msg-error" id="err-settings-profile"></div>
      <div class="msg-success" id="ok-settings-profile"></div>
      <div class="settings-row">
        <div class="form-group" style="margin-bottom:0"><label>Full name</label><input type="text" id="set-name" placeholder="Your name" /></div>
        <div class="form-group" style="margin-bottom:0"><label>Email address</label><input type="email" id="set-email" disabled style="opacity:.6;cursor:not-allowed" /></div>
      </div>
      <button class="btn-full" id="btn-save-profile" style="margin-top:18px;max-width:200px" onclick="doSaveProfile()">Save changes</button>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Change Password</div>
      <div class="msg-error" id="err-settings-pass"></div>
      <div class="msg-success" id="ok-settings-pass"></div>
      <div class="form-group"><label>Current password</label><input type="password" id="set-pass-current" placeholder="Your current password" /></div>
      <div class="settings-row">
        <div class="form-group" style="margin-bottom:0"><label>New password</label><input type="password" id="set-pass-new" placeholder="At least 8 characters" /></div>
        <div class="form-group" style="margin-bottom:0"><label>Confirm new password</label><input type="password" id="set-pass-new2" placeholder="Repeat new password" /></div>
      </div>
      <button class="btn-full" id="btn-change-pass" style="margin-top:18px;max-width:200px" onclick="doChangePassword()">Update password</button>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Current Plan</div>
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px">
        <div>
          <div style="font-size:24px;font-weight:800;color:var(--navy)" id="set-plan-name">—</div>
          <div style="font-size:13px;color:var(--gray-400);margin-top:4px" id="set-plan-detail"></div>
        </div>
        <button class="btn-primary" onclick="showPage('subscribe')">View Plans</button>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Your Data (POPIA)</div>
      <p style="font-size:13px;color:var(--gray-600);margin-bottom:8px">Under POPIA you have the right to access the personal data we hold about you. Download a copy of your account information as a JSON file.</p>
      <p style="font-size:12px;color:var(--gray-400);margin-bottom:16px">Note: Your comparison history is stored only in this browser and is not held on our servers — it will be included in the export automatically.</p>
      <div class="msg-error" id="err-export-data"></div>
      <div class="msg-success" id="ok-export-data"></div>
      <button class="btn-sm" style="font-size:13px;padding:8px 18px;background:var(--navy);color:#fff;border:none;border-radius:6px;cursor:pointer" onclick="doExportData()">Download my data</button>
    </div>

    <div class="settings-section" style="border-color:#fca5a5">
      <div class="settings-section-title" style="color:#dc2626;border-bottom-color:#fca5a5">Sign Out</div>
      <p style="font-size:13px;color:var(--gray-600);margin-bottom:16px">This will end your session on this device.</p>
      <button class="btn-sm btn-sm-danger" style="font-size:13px;padding:8px 18px" onclick="doSignOut()">Sign out of this device</button>
    </div>

    <div class="settings-section" style="border-color:#fca5a5">
      <div class="settings-section-title" style="color:#dc2626;border-bottom-color:#fca5a5">Delete Account</div>
      <p style="font-size:13px;color:var(--gray-600);margin-bottom:16px">Permanently delete your account and all associated data. This cannot be undone. In accordance with POPIA, you have the right to request deletion of all data we hold about you.</p>
      <div class="msg-error" id="err-delete-account"></div>
      <div class="msg-success" id="ok-delete-account"></div>
      <button class="btn-sm btn-sm-danger" style="font-size:13px;padding:8px 18px" onclick="doDeleteAccount()">Delete my account</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     TEAM
═══════════════════════════════ -->
<div class="page" id="page-team">
  <div class="dash-wrap">
    <div class="page-title-bar">
      <button class="page-back-btn" onclick="showPage('dashboard')">&#8592; Back</button>
      <div class="dash-welcome" style="margin:0">Team</div>
    </div>
    <div class="dash-sub" style="margin-bottom:24px">Manage who has access to your subscription</div>

    <div class="settings-section" id="team-invite-section">
      <div class="settings-section-title">Invite a member</div>
      <div class="msg-error" id="err-team-invite"></div>
      <div class="msg-success" id="ok-team-invite"></div>
      <div style="display:flex;gap:10px;align-items:flex-end">
        <div class="form-group" style="flex:1;margin-bottom:0">
          <label>Email address</label>
          <input type="email" id="team-invite-email" placeholder="colleague@example.com" onkeydown="if(event.key==='Enter')doInviteMember()" />
        </div>
        <button class="btn-primary" id="btn-invite" style="padding:12px 22px;white-space:nowrap" onclick="doInviteMember()">Send Invite</button>
      </div>
    </div>

    <div class="settings-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid var(--gray-100)">
        <div style="font-size:15px;font-weight:700;color:var(--navy)">Members <span id="team-count" style="font-size:13px;font-weight:400;color:var(--gray-400)"></span></div>
        <button class="btn-sm" onclick="loadTeam()">Refresh</button>
      </div>
      <div class="msg-error" id="err-team"></div>
      <div class="msg-success" id="ok-team"></div>
      <div id="team-members-list">
        <div style="text-align:center;padding:32px;color:var(--gray-400);font-size:14px">Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════
     SCRIPTS
═══════════════════════════════ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha384-Yv5O+t3uE3hunW8uyrbpPW3iw6/5/Y7HitWJBLgqfMoA36NogMmy+8wWZMpn3HWc" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha384-/1qUCSGwTur9vjf/z9lmu/eCUYbpOTgSjmpbMQZ1/CtX2v/WcAIKqRv+U1DUCG6e" crossorigin="anonymous"></script>
<script>
  // ── App Version ──────────────────────────────────────────────
  const APP_VERSION = '0.7.2';

  // ── Device ID (for free trial tracking) ─────────────────────
  function getDeviceId() {
    let id = localStorage.getItem('rs_device_id');
    if (!id) {
      if (crypto.randomUUID) {
        id = crypto.randomUUID();
      } else {
        // Cryptographically secure fallback via getRandomValues (no Math.random)
        const buf = new Uint8Array(16);
        crypto.getRandomValues(buf);
        buf[6] = (buf[6] & 0x0f) | 0x40; // version 4
        buf[8] = (buf[8] & 0x3f) | 0x80; // variant
        id = [...buf].map((b, i) =>
          ([4, 6, 8, 10].includes(i) ? '-' : '') + b.toString(16).padStart(2, '0')
        ).join('');
      }
      localStorage.setItem('rs_device_id', id);
    }
    return id;
  }

  // ── Backend URL ──────────────────────────────────────────────
  const N8N_BASE = 'https://n8n.srv1194492.hstgr.cloud/webhook';

  // ── Session helpers (localStorage) ──────────────────────────
  function saveSession(data) {
    localStorage.setItem('rs_session', JSON.stringify(data));
    currentUser = data;
  }
  function loadSession() {
    try { return JSON.parse(localStorage.getItem('rs_session')); } catch { return null; }
  }
  function clearSession() {
    localStorage.removeItem('rs_session');
    currentUser = null;
  }

  let currentUser     = null;
  let htmlToCopy      = '';
  let currentPage     = 'landing';
  let lastOldData     = null;  // stored after successful PDF extraction, used for retry
  let lastNewData     = null;
  let updateAvailable = false;
  let knownEtag       = null;

  // ── Auto-update detection ────────────────────────────────────
  // HEAD request every 5 min — when Cloudflare deploys a new version
  // the ETag changes; show a banner (held until comparison finishes).
  async function checkForUpdate() {
    try {
      const resp = await fetch(location.pathname, {
        method: 'HEAD',
        headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' },
        cache: 'no-store'
      });
      const etag = resp.headers.get('etag') || resp.headers.get('last-modified');
      if (!etag) return;
      if (!knownEtag) { knownEtag = etag; return; }
      if (etag !== knownEtag) {
        updateAvailable = true;
        if (!g('proc-panel').classList.contains('show')) {
          g('update-bar').classList.add('show');
        }
      }
    } catch { /* ignore network errors */ }
  }
  checkForUpdate();
  setInterval(checkForUpdate, 5 * 60 * 1000);

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // ── Auth init (replaces Firebase onAuthStateChanged) ─────────
  let pendingResetToken  = null;
  let pendingInviteToken = null;

  function dismissLoader() {
    const loader = document.getElementById('page-loader');
    if (loader) { loader.classList.add('hidden'); setTimeout(() => loader.remove(), 300); }
  }

  async function initAuth() {
    try {
      const params = new URLSearchParams(window.location.search);

      // ?verify=TOKEN — call verify endpoint then go to login
      const verifyToken = params.get('verify');
      if (verifyToken) {
        try {
          await fetch(N8N_BASE + '/auth/verify-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: verifyToken })
          });
        } catch {}
        history.replaceState(null, '', location.pathname);
        sessionStorage.setItem('rs_verified', '1');
      }

      // ?reset=TOKEN — store token, show reset-password page
      const resetToken = params.get('reset');
      if (resetToken) {
        pendingResetToken = resetToken;
        history.replaceState(null, '', location.pathname);
        showPage('reset-password');
        return;
      }

      // ?invite=TOKEN — store token, show accept-invite page
      const inviteToken = params.get('invite');
      if (inviteToken) {
        pendingInviteToken = inviteToken;
        history.replaceState(null, '', location.pathname);
        const session = loadSession();
        if (session && session.token) {
          currentUser = session;
          setNav(true, session.name || session.email);
          const lp = g('invite-login-prompt'); if (lp) lp.style.display = 'none';
          const ab = g('invite-accept-btn');   if (ab) ab.style.display = 'block';
        } else {
          const lp = g('invite-login-prompt'); if (lp) lp.style.display = 'block';
          const ab = g('invite-accept-btn');   if (ab) ab.style.display = 'none';
        }
        showPage('accept-invite');
        return;
      }

      // ?changepass=TOKEN — confirm password change then show login with result
      const changePwToken = params.get('changepass');
      if (changePwToken) {
        history.replaceState(null, '', location.pathname);
        let changed = false, changePwErr = '';
        try {
          const r = await fetch(N8N_BASE + '/auth/confirm-password-change', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: changePwToken })
          });
          const d = await r.json();
          if (d.success) { changed = true; }
          else { changePwErr = d.error || 'Link invalid or expired.'; }
        } catch { changePwErr = 'Connection error. Please try again.'; }
        showPage('login');
        const el = g('err-login');
        if (el) {
          if (changed) {
            el.style.cssText = 'background:#f0fdf4;border-color:#86efac;color:#16a34a;display:block';
            el.textContent = 'Password changed successfully. Please log in with your new password.';
          } else {
            showErr('err-login', changePwErr);
          }
        }
        return;
      }

      const session = loadSession();
      if (session && session.token) {
        currentUser = session;
        const name = session.name || session.email?.split('@')[0] || 'User';
        setNav(true, name);
        loadDashboard();
        const savedPage = sessionStorage.getItem('rs_page');
        const dest = (savedPage && !['login','signup','verify'].includes(savedPage)) ? savedPage : 'dashboard';
        showPage(dest);
      } else {
        currentUser = null;
        setNav(false);
        const savedPage = sessionStorage.getItem('rs_page');
        const publicPages = ['landing','why','subscribe','terms','privacy','support'];
        const dest = (savedPage && publicPages.includes(savedPage)) ? savedPage : 'landing';
        showPage(dest);
      }
    } catch(e) {
      console.error('initAuth error:', e);
      showPage('landing');
    } finally {
      dismissLoader();
    }
  }
  function setNav(loggedIn, name) {
    document.getElementById('nav-public').style.display  = loggedIn ? 'none' : 'flex';
    document.getElementById('nav-private').style.display = loggedIn ? 'flex' : 'none';
    if (name) {
      document.getElementById('nav-name').textContent = name;
      const av = document.getElementById('nav-avatar');
      if (av) av.textContent = name.trim().charAt(0).toUpperCase();
    }
  }

  function loadDashboard() {
    if (!currentUser) return;
    const sub     = currentUser.subscription || {};
    const name    = currentUser.name || currentUser.email?.split('@')[0] || 'User';
    const isTrial = !sub.plan || sub.plan === 'none' || sub.plan === 'trial';
    const plan    = isTrial ? 'Free Trial' : (sub.plan.charAt(0).toUpperCase() + sub.plan.slice(1));
    const limit   = isTrial ? 5 : (sub.maxComparisons || 25);
    const count   = sub.comparisonsUsed || 0;
    document.getElementById('dash-name').textContent  = name;
    document.getElementById('dash-count').textContent = count;
    document.getElementById('dash-limit').textContent = limit;
    document.getElementById('dash-tier').textContent  = plan;
    const planLimitEl = g('dash-plan-limit');
    if (planLimitEl) planLimitEl.textContent = isTrial ? '5 lifetime free comparisons' : (limit + ' comparisons per month');
    const pct = Math.min(100, Math.round(count / limit * 100));
    document.getElementById('dash-bar').style.width      = pct + '%';
    document.getElementById('dash-bar').style.background = pct >= 90 ? 'var(--red)' : pct >= 75 ? 'var(--amber)' : 'var(--blue)';
    const limitWarning = g('dash-limit-warning');
    if (limitWarning) {
      if (pct >= 90) {
        const msg = isTrial
          ? (pct >= 100 ? 'You\u2019ve used all 5 free comparisons.' : 'You\u2019re nearly out of free comparisons.')
          : (pct >= 100 ? 'You\u2019ve reached your monthly limit.' : 'You\u2019re nearly at your monthly limit.');
        limitWarning.innerHTML = `${msg} <a href="#" onclick="showPage('subscribe');return false;" style="display:inline-block;margin-left:10px;background:var(--navy);color:#fff;padding:4px 14px;border-radius:6px;font-size:12px;font-weight:600;text-decoration:none">${isTrial ? 'View Plans' : 'Upgrade Plan'}</a>`;
        limitWarning.style.display = 'block';
      } else { limitWarning.style.display = 'none'; }
    }
    loadRenewals();
  }

  function renewalsKey() {
    return currentUser ? 'renewals_' + currentUser.userId : 'renewals_guest';
  }
  function saveRenewalRecord(clientName, durationSecs, resultData, resultHtml, notes) {
    try {
      const list = JSON.parse(localStorage.getItem(renewalsKey()) || '[]');
      const pctChange = (resultData?.oldTotal && resultData?.newTotal && resultData.oldTotal !== 0)
        ? Math.round(((resultData.newTotal - resultData.oldTotal) / resultData.oldTotal) * 100) : null;
      list.unshift({ clientName, durationSecs, completedAt: new Date().toISOString(), pctChange, result: resultData || null, resultHtml: resultHtml || '', notes: notes || '' });
      if (list.length > 20) list.length = 20;
      localStorage.setItem(renewalsKey(), JSON.stringify(list));
    } catch(e) { console.warn('Failed to save renewal record', e); }
  }
  function renderRenewalRows(list) {
    const tbody = g('renewals-tbody');
    if (!tbody) return;
    if (!list.length) {
      const isFiltered = (g('history-search')?.value || '').trim().length > 0;
      tbody.innerHTML = isFiltered
        ? `<tr><td colspan="5" style="padding:24px 20px;text-align:center;color:var(--gray-400)">No results match your search.</td></tr>`
        : `<tr><td colspan="5" style="padding:36px 20px;text-align:center">
            <div style="font-size:32px;margin-bottom:10px">&#128196;</div>
            <div style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:6px">No comparisons yet</div>
            <div style="font-size:13px;color:var(--gray-400);margin-bottom:16px">Upload two policy PDFs to run your first AI comparison</div>
            <button onclick="showPage('compare')" style="background:var(--blue);color:#fff;border:none;padding:10px 22px;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif">Start Your First Comparison &rarr;</button>
          </td></tr>`;
      return;
    }
    // Build a real-index lookup so delete still works on the full list
    const fullList = JSON.parse(localStorage.getItem(renewalsKey()) || '[]');
    tbody.innerHTML = list.map(r => {
      const i = fullList.indexOf(r);
      const date = r.completedAt ? new Date(r.completedAt).toLocaleDateString('en-ZA', { day:'2-digit', month:'short', year:'numeric' }) : '—';
      const dur = r.durationSecs ? (r.durationSecs >= 60 ? Math.floor(r.durationSecs/60) + 'm ' + (r.durationSecs%60) + 's' : r.durationSecs + 's') : '—';
      let changeTd;
      if (typeof r.pctChange === 'number') {
        const inc = r.pctChange >= 0;
        changeTd = `<td style="padding:11px 14px;border-bottom:1px solid var(--gray-100);text-align:right">
          <span style="display:inline-block;padding:3px 8px;border-radius:12px;font-size:12px;font-weight:700;background:${inc?'#fee2e2':'#dcfce7'};color:${inc?'#dc2626':'#16a34a'}">${inc?'▲':'▼'} ${inc?'+':''}${r.pctChange}%</span>
        </td>`;
      } else {
        changeTd = `<td style="padding:11px 14px;border-bottom:1px solid var(--gray-100);text-align:right;color:var(--gray-400)">—</td>`;
      }
      const delBtn = `<button onclick="deleteRenewal(${i})" title="Delete this record" style="background:none;border:1px solid var(--gray-200);color:var(--gray-400);padding:5px 9px;border-radius:6px;font-size:12px;cursor:pointer;font-family:Inter,sans-serif;margin-left:6px" onmouseover="this.style.borderColor='#dc2626';this.style.color='#dc2626'" onmouseout="this.style.borderColor='var(--gray-200)';this.style.color='var(--gray-400)'">&#128465;</button>`;
      const actionsTd = r.result
        ? `<td style="padding:11px 14px;border-bottom:1px solid var(--gray-100);text-align:right"><button onclick="viewStoredComparison(${i})" style="background:var(--blue);color:#fff;border:none;padding:5px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif">View</button>${delBtn}</td>`
        : `<td style="padding:11px 14px;border-bottom:1px solid var(--gray-100);text-align:right">${delBtn}</td>`;
      return `<tr>
        <td style="padding:11px 14px;font-size:13px;font-weight:600;color:var(--navy);border-bottom:1px solid var(--gray-100)">${esc(r.clientName)||'—'}</td>
        <td style="padding:11px 14px;font-size:13px;color:var(--gray-600);border-bottom:1px solid var(--gray-100)">${date}</td>
        <td style="padding:11px 14px;font-size:13px;color:var(--gray-600);border-bottom:1px solid var(--gray-100);text-align:right">${dur}</td>
        ${changeTd}
        ${actionsTd}
      </tr>`;
    }).join('');
  }

  function loadRenewals() {
    try {
      const list = JSON.parse(localStorage.getItem(renewalsKey()) || '[]');
      const countEl = g('dash-history-count');
      if (countEl) countEl.textContent = list.length ? list.length + ' total' : '';
      const clearBtn = g('btn-clear-history');
      if (clearBtn) clearBtn.style.display = list.length ? 'inline-block' : 'none';
      const searchEl = g('history-search');
      if (searchEl) searchEl.value = '';
      renderRenewalRows(list);
    } catch(e) { console.warn('Failed to load renewals', e); }
  }

  window.filterHistory = function(query) {
    try {
      const q = (query || '').toLowerCase().trim();
      const list = JSON.parse(localStorage.getItem(renewalsKey()) || '[]');
      const filtered = q ? list.filter(r => (r.clientName || '').toLowerCase().includes(q)) : list;
      renderRenewalRows(filtered);
    } catch(e) { console.warn('Failed to filter history', e); }
  };

  // ── FAQ accordion ─────────────────────────────────────────────
  window.toggleFaq = function(btn) {
    btn.parentElement.classList.toggle('open');
  };

  window.deleteRenewal = function(i) {
    try {
      const list = JSON.parse(localStorage.getItem(renewalsKey()) || '[]');
      list.splice(i, 1);
      localStorage.setItem(renewalsKey(), JSON.stringify(list));
      loadRenewals();
    } catch(e) { console.warn('Failed to delete renewal record', e); }
  };

  window.clearAllHistory = function() {
    if (!confirm('Clear all renewal history? This cannot be undone.')) return;
    localStorage.removeItem(renewalsKey());
    loadRenewals();
  };

  // Usage is tracked server-side on the subscription record

  // ── Login ────────────────────────────────────────────────────
  window.doLoginEmail = async function() {
    const email = g('l-email').value.trim();
    const pass  = g('l-pass').value;
    const btn   = g('btn-login');
    clearErr('err-login');
    if (!email || !pass) { showErr('err-login', 'Please enter your email and password.'); return; }
    btn.disabled = true; btn.textContent = 'Signing in...';
    try {
      const resp = await fetch(N8N_BASE + '/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password: pass })
      });
      const data = await resp.json();
      if (!resp.ok) {
        const msg = data.error || 'Invalid email or password.';
        if (msg.toLowerCase().includes('verif')) {
          sessionStorage.setItem('rs_pending_email', email);
          g('verify-email').textContent = email;
          showPage('verify');
          showErr('err-verify', 'Your email is not yet verified. Click below to receive a new verification link.');
          btn.disabled=false; btn.textContent='Sign in'; return;
        }
        showErr('err-login', msg); btn.disabled=false; btn.textContent='Sign in'; return;
      }
      saveSession(data);
      setNav(true, data.name || data.email);
      loadDashboard();
      showPage('dashboard');
    } catch(e) {
      showErr('err-login', 'Could not connect. Check your internet connection.');
      btn.disabled=false; btn.textContent='Sign in';
    }
  };

  window.doForgotPassword = async function() {
    const email = g('l-email').value.trim();
    if (!email) { showErr('err-login', 'Enter your email address first, then click Forgot password.'); return; }
    try {
      await fetch(N8N_BASE + '/auth/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const el = g('err-login');
      el.style.cssText = 'background:#f0fdf4;border-color:#86efac;color:#16a34a;display:block';
      el.textContent = 'If that email is registered, a password reset link has been sent.';
    } catch(e) { showErr('err-login', 'Could not connect. Please try again.'); }
  };

  // ── Sign Up ──────────────────────────────────────────────────
  window.doSignUp = async function() {
    const firstName = g('s-fname').value.trim();
    const surname   = g('s-lname').value.trim();
    const name      = firstName + ' ' + surname;
    const email = g('s-email').value.trim();
    const pass  = g('s-pass').value;
    const pass2 = g('s-pass2').value;
    const btn   = g('btn-signup');
    clearErr('err-signup');
    if (!firstName||!surname||!email||!pass||!pass2) { showErr('err-signup', 'Please fill in all fields.'); return; }
    if (pass !== pass2) { showErr('err-signup', 'Passwords do not match.'); return; }
    if (pass.length < 8) { showErr('err-signup', 'Password must be at least 8 characters.'); return; }
    if (!g('consent-popia').checked) { showErr('err-signup', 'Please accept the privacy policy to continue.'); return; }
    btn.disabled = true; btn.textContent = 'Creating account...';
    try {
      const resp = await fetch(N8N_BASE + '/auth/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, password: pass })
      });
      const data = await resp.json();
      if (!resp.ok) { showErr('err-signup', data.error || 'Signup failed. Please try again.'); btn.disabled=false; btn.textContent='Create account'; return; }
      sessionStorage.setItem('rs_pending_email', email);
      g('verify-email').textContent = email;
      showPage('verify');
    } catch(e) {
      showErr('err-signup', 'Could not connect. Check your internet connection.');
      btn.disabled=false; btn.textContent='Create account';
    }
  };

  // ── Verify Email ─────────────────────────────────────────────
  window.doCheckVerify = function() {
    // Verification happens when user clicks the link in their email.
    // Direct them to login — if verified the login will succeed.
    showPage('login');
  };

  window.doResendVerify = async function() {
    const email = sessionStorage.getItem('rs_pending_email') || '';
    if (!email) { showErr('err-verify', 'Could not find your email. Please go back and try signing in again.'); return; }
    try {
      await fetch(N8N_BASE + '/auth/resend-verification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      showOk('ok-verify', 'Verification email sent! Check your inbox and click the link.');
    } catch(e) { showErr('err-verify', 'Could not send email. Please try again.'); }
  };

  // ── Sign Out ─────────────────────────────────────────────────
  window.doSignOut = async function() {
    sessionStorage.removeItem('rs_page');
    if (currentUser?.token) {
      try {
        await fetch(N8N_BASE + '/auth/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + currentUser.token }
        });
      } catch {}
    }
    clearSession();
    setNav(false);
    showPage('landing');
  };

  // ── Delete Account ───────────────────────────────────────────
  window.doDeleteAccount = async function() {
    clearErr('err-delete-account');
    if (!confirm('Are you sure you want to permanently delete your account? All your data will be erased and this cannot be undone.')) return;
    const token = currentUser?.token;
    if (!token) { showErr('err-delete-account', 'Not logged in.'); return; }
    const btn = document.querySelector('[onclick="doDeleteAccount()"]');
    if (btn) { btn.disabled = true; btn.textContent = 'Deleting…'; }
    try {
      const resp = await fetch(N8N_BASE + '/auth/delete-account', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) {
        if (btn) { btn.disabled = false; btn.textContent = 'Delete my account'; }
        showErr('err-delete-account', data.error || 'Failed to delete account. Please contact support@taskautomateai.co.za.');
        return;
      }
      localStorage.clear();
      sessionStorage.clear();
      currentUser = null;
      setNav(false);
      showPage('landing');
    } catch(e) {
      if (btn) { btn.disabled = false; btn.textContent = 'Delete my account'; }
      showErr('err-delete-account', 'Could not connect. Please contact support@taskautomateai.co.za to request account deletion.');
    }
  };

  // ── Export My Data (POPIA data portability) ──────────────────
  window.doExportData = async function() {
    clearErr('err-export-data');
    const token = currentUser?.token;
    const userId = currentUser?.userId;
    if (!token) { showErr('err-export-data', 'Not logged in.'); return; }
    const btn = document.querySelector('[onclick="doExportData()"]');
    if (btn) { btn.disabled = true; btn.textContent = 'Preparing…'; }
    try {
      const resp = await fetch(N8N_BASE + '/auth/export-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) {
        showErr('err-export-data', data.error || 'Failed to retrieve data. Please try again.');
        if (btn) { btn.disabled = false; btn.textContent = 'Download my data'; }
        return;
      }
      // Gather localStorage data using correct storage keys
      const history = JSON.parse(localStorage.getItem('renewals_' + userId) || '[]');
      const savedNotes = JSON.parse(localStorage.getItem('pdfnotes_' + userId) || '[]');
      const exportPayload = {
        exportGeneratedAt: data.data?.exportGeneratedAt || new Date().toISOString(),
        serverData: {
          email: data.data?.email,
          name: data.data?.name || '',
          accountCreated: data.data?.accountCreated,
          plan: data.data?.plan,
          maxComparisons: data.data?.maxComparisons,
          comparisonsUsed: data.data?.comparisonsUsed
        },
        localData: {
          comparisonHistory: history,
          savedNotes: savedNotes,
          note: 'localData is stored only in this browser and was never transmitted to our servers.'
        }
      };
      const blob = new Blob([JSON.stringify(exportPayload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'renewalscan-data-' + new Date().toISOString().slice(0,10) + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showOk('ok-export-data', 'Your data export has been downloaded.');
    } catch(e) {
      showErr('err-export-data', 'Could not connect. Please try again.');
    } finally {
      if (btn) { btn.disabled = false; btn.textContent = 'Download my data'; }
    }
  };

  // ── Reset Password ───────────────────────────────────────────
  window.doResetPassword = async function() {
    const pass  = (g('r-pass')?.value || '').trim();
    const pass2 = (g('r-pass2')?.value || '').trim();
    clearErr('err-reset');
    if (!pendingResetToken) { showErr('err-reset', 'Invalid or expired reset link. Please request a new one.'); return; }
    if (pass.length < 8)   { showErr('err-reset', 'Password must be at least 8 characters.'); return; }
    if (pass !== pass2)    { showErr('err-reset', 'Passwords do not match.'); return; }
    const btn = g('btn-reset-pass');
    btn.disabled = true; btn.textContent = 'Resetting…';
    try {
      const res  = await fetch(N8N_BASE + '/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: pendingResetToken, password: pass })
      });
      const data = await res.json();
      if (!res.ok || data.error) { showErr('err-reset', data.error || 'Reset failed. The link may have expired.'); return; }
      pendingResetToken = null;
      showOk('ok-reset', 'Password updated! You can now sign in.');
      setTimeout(() => showPage('login'), 2000);
    } catch(e) {
      showErr('err-reset', 'Connection error. Please try again.');
    } finally {
      btn.disabled = false; btn.textContent = 'Set New Password';
    }
  };

  // ── Accept Invite ─────────────────────────────────────────────
  window.doAcceptInvite = async function() {
    clearErr('err-invite');
    if (!pendingInviteToken) { showErr('err-invite', 'Invalid or expired invite link.'); return; }
    // If not logged in, prompt login first (handled by initAuth showing the prompt)
    if (!currentUser?.token) { showPage('login'); return; }
    const btn = g('btn-accept-invite');
    btn.disabled = true; btn.textContent = 'Accepting…';
    try {
      const res  = await fetch(N8N_BASE + '/team/accept-invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + currentUser.token },
        body: JSON.stringify({ token: pendingInviteToken })
      });
      const data = await res.json();
      if (!res.ok || data.error) { showErr('err-invite', data.error || 'Could not accept invite. The link may have expired.'); return; }
      pendingInviteToken = null;
      // Refresh session so org membership is reflected
      if (data.session) { saveSession(data.session); }
      showOk('ok-invite', 'You have joined the team! Redirecting…');
      setTimeout(() => showPage('dashboard'), 1800);
    } catch(e) {
      showErr('err-invite', 'Connection error. Please try again.');
    } finally {
      btn.disabled = false; btn.textContent = 'Accept Invitation';
    }
  };

  // ── Settings Page ────────────────────────────────────────────
  function loadSettingsPage() {
    if (!currentUser) return;
    const nameEl  = g('set-name');
    const emailEl = g('set-email');
    if (nameEl)  nameEl.value  = currentUser.name  || '';
    if (emailEl) emailEl.value = currentUser.email || '';
    const sub      = currentUser.subscription || {};
    const isTrial  = !sub.plan || sub.plan === 'none' || sub.plan === 'trial';
    const planEl   = g('set-plan-name');
    const detailEl = g('set-plan-detail');
    if (planEl)   planEl.textContent   = isTrial ? 'Free Trial' : (sub.plan.charAt(0).toUpperCase() + sub.plan.slice(1));
    if (detailEl) detailEl.textContent = isTrial
      ? ((sub.comparisonsUsed || 0) + ' / 5 lifetime free comparisons used')
      : ((sub.comparisonsUsed || 0) + ' / ' + (sub.maxComparisons || 25) + ' comparisons used this month');
  }

  window.doSaveProfile = async function() {
    clearErr('err-settings-profile');
    const name = (g('set-name')?.value || '').trim();
    if (!name) { showErr('err-settings-profile', 'Name cannot be empty.'); return; }
    const btn = g('btn-save-profile');
    btn.disabled = true; btn.textContent = 'Saving…';
    try {
      const res  = await fetch(N8N_BASE + '/auth/update-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + currentUser.token },
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if (!res.ok || data.error) { showErr('err-settings-profile', data.error || 'Save failed.'); return; }
      currentUser.name = name;
      saveSession(currentUser);
      setNav(true, name);
      showOk('ok-settings-profile', 'Profile updated.');
    } catch(e) {
      showErr('err-settings-profile', 'Connection error. Please try again.');
    } finally {
      btn.disabled = false; btn.textContent = 'Save Changes';
    }
  };

  window.doChangePassword = async function() {
    clearErr('err-settings-pass');
    const current  = (g('set-pass-current')?.value || '');
    const newPw    = (g('set-pass-new')?.value || '');
    const confirm  = (g('set-pass-new2')?.value || '');
    if (!current)         { showErr('err-settings-pass', 'Enter your current password.'); return; }
    if (newPw.length < 8) { showErr('err-settings-pass', 'New password must be at least 8 characters.'); return; }
    if (newPw !== confirm) { showErr('err-settings-pass', 'Passwords do not match.'); return; }
    const btn = g('btn-change-pass');
    btn.disabled = true; btn.textContent = 'Sending…';
    try {
      const res  = await fetch(N8N_BASE + '/auth/request-password-change', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + currentUser.token },
        body: JSON.stringify({ currentPassword: current, newPassword: newPw })
      });
      const data = await res.json();
      if (!res.ok || data.error) { showErr('err-settings-pass', data.error || 'Password change failed.'); return; }
      g('set-pass-current').value = '';
      g('set-pass-new').value = '';
      g('set-pass-new2').value = '';
      showOk('ok-settings-pass', 'Check your email for a confirmation link to complete the password change.');
    } catch(e) {
      showErr('err-settings-pass', 'Connection error. Please try again.');
    } finally {
      btn.disabled = false; btn.textContent = 'Update Password';
    }
  };

  // ── Team Management ──────────────────────────────────────────
  let teamMembers = [];

  async function loadTeam() {
    if (!currentUser?.token) return;
    const list = g('team-members-list');
    if (!list) return;
    list.innerHTML = '<p style="color:var(--gray-400);font-size:13px">Loading…</p>';
    clearErr('err-team');
    try {
      const res  = await fetch(N8N_BASE + '/team/members', {
        headers: { 'Authorization': 'Bearer ' + currentUser.token }
      });
      const data = await res.json();
      if (!res.ok || data.error) { list.innerHTML = ''; showErr('err-team', data.error || 'Could not load team.'); return; }
      teamMembers = data.members || [];
      // Show/hide invite section based on caller's role
      const myMember = teamMembers.find(m => m.userId === currentUser.userId);
      const myRole = myMember?.role || 'member';
      const invSec = g('team-invite-section');
      if (invSec) invSec.style.display = (myRole === 'owner' || myRole === 'admin') ? '' : 'none';
      renderTeam();
    } catch(e) {
      list.innerHTML = '';
      showErr('err-team', 'Connection error loading team.');
    }
  }

  function renderTeam() {
    const list = g('team-members-list');
    if (!list) return;
    if (!teamMembers.length) { list.innerHTML = '<p style="color:var(--gray-400);font-size:13px">No team members yet.</p>'; return; }
    const myMemberRecord = teamMembers.find(m => m.userId === currentUser.userId);
    const isOwner = myMemberRecord?.role === 'owner';
    const isAdminOrOwner = isOwner || myMemberRecord?.role === 'admin';
    // Update seat count display
    const countEl = g('team-count');
    if (countEl) {
      const maxSeats = currentUser.subscription?.maxSeats;
      countEl.textContent = maxSeats ? `(${teamMembers.length} of ${maxSeats} seats used)` : `(${teamMembers.length} member${teamMembers.length !== 1 ? 's' : ''})`;
    }
    list.innerHTML = teamMembers.map(m => {
      const isMe  = m.userId === currentUser.userId;
      const initials = (m.name || m.email || '?').charAt(0).toUpperCase();
      const roleClass = m.role === 'owner' ? 'role-owner' : m.role === 'admin' ? 'role-admin' : 'role-member';
      const actions = (!isMe && isOwner) ? `
        <div class="member-actions">
          ${m.role !== 'admin' ? `<button class="btn-sm" onclick="doPromoteMember('${m.userId}')">Make Admin</button>` : `<button class="btn-sm" onclick="doDemoteMember('${m.userId}')">Remove Admin</button>`}
          <button class="btn-sm btn-sm-danger" data-uid="${m.userId}" data-display="${esc(m.name||m.email)}" onclick="doRemoveMember(this.dataset.uid,this.dataset.display)">Remove</button>
        </div>` : '';
      return `<div class="team-member-row">
        <div class="member-info">
          <div class="member-avatar">${esc((m.name||m.email||'?').charAt(0).toUpperCase())}</div>
          <div>
            <div class="member-name">${esc(m.name) || '—'}${isMe ? ' <span style="font-size:11px;color:var(--gray-400)">(you)</span>' : ''}</div>
            <div class="member-email">${esc(m.email)}</div>
          </div>
        </div>
        <span class="member-role-badge ${roleClass}">${esc(m.role)}</span>
        ${actions}
      </div>`;
    }).join('');
  }

  window.doInviteMember = async function() {
    clearErr('err-team-invite');
    const email = (g('team-invite-email')?.value || '').trim().toLowerCase();
    if (!email || !email.includes('@')) { showErr('err-team-invite', 'Enter a valid email address.'); return; }
    const btn = g('btn-invite');
    btn.disabled = true; btn.textContent = 'Sending…';
    try {
      const res  = await fetch(N8N_BASE + '/team/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + currentUser.token },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (!res.ok || data.error) { showErr('err-team-invite', data.error || 'Invite failed.'); return; }
      g('team-invite-email').value = '';
      showOk('ok-team-invite', 'Invite sent to ' + email);
    } catch(e) {
      showErr('err-team-invite', 'Connection error. Please try again.');
    } finally {
      btn.disabled = false; btn.textContent = 'Send Invite';
    }
  };

  window.doRemoveMember = async function(userId, name) {
    if (!confirm('Remove ' + name + ' from your team?')) return;
    clearErr('err-team');
    try {
      const res  = await fetch(N8N_BASE + '/team/remove-member', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + currentUser.token },
        body: JSON.stringify({ targetUserId: userId })
      });
      const data = await res.json();
      if (!res.ok || data.error) { showErr('err-team', data.error || 'Could not remove member.'); return; }
      teamMembers = teamMembers.filter(m => m.userId !== userId);
      renderTeam();
      showOk('ok-team', name + ' has been removed.');
    } catch(e) {
      showErr('err-team', 'Connection error. Please try again.');
    }
  };

  window.doPromoteMember = async function(userId) {
    clearErr('err-team');
    try {
      const res  = await fetch(N8N_BASE + '/team/promote-member', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + currentUser.token },
        body: JSON.stringify({ targetUserId: userId, role: 'admin' })
      });
      const data = await res.json();
      if (!res.ok || data.error) { showErr('err-team', data.error || 'Could not update role.'); return; }
      const m = teamMembers.find(m => m.userId === userId);
      if (m) { m.role = 'admin'; renderTeam(); }
    } catch(e) {
      showErr('err-team', 'Connection error. Please try again.');
    }
  };

  window.doDemoteMember = async function(userId) {
    clearErr('err-team');
    try {
      const res  = await fetch(N8N_BASE + '/team/promote-member', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + currentUser.token },
        body: JSON.stringify({ targetUserId: userId, role: 'member' })
      });
      const data = await res.json();
      if (!res.ok || data.error) { showErr('err-team', data.error || 'Could not update role.'); return; }
      const m = teamMembers.find(m => m.userId === userId);
      if (m) { m.role = 'member'; renderTeam(); }
    } catch(e) {
      showErr('err-team', 'Connection error. Please try again.');
    }
  };

  // ── PDF Extraction ───────────────────────────────────────────
  async function extractPdf(file, password) {
    const buf = await file.arrayBuffer();
    const loadParams = { data: buf };
    if (password) loadParams.password = password;
    try {
      const pdf = await pdfjsLib.getDocument(loadParams).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page    = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(it => it.str).join(' ') + '\n';
      }
      return text.trim();
    } catch(e) {
      if (e.name === 'PasswordException' || e.message?.includes('password')) {
        throw new Error('Incorrect PDF password for "' + file.name + '". Please check and try again.');
      }
      throw e;
    }
  }

  window.onFileSelect = function(w) {
    const f = g('file-' + w).files[0];
    if (!f) return;
    if (f.size > 10 * 1024 * 1024) {
      showErr('err-compare', '"' + f.name + '" is very large (' + (f.size/1024/1024).toFixed(1) + ' MB) and may fail to process. Try a smaller file.');
    }
    g('zone-' + w).classList.add('loaded');
    g('fn-' + w).textContent = '\u2713 ' + f.name;
    checkFiles();
  };
  window.onDragOver  = (e,w) => { e.preventDefault(); g('zone-'+w).classList.add('drag-over'); };
  window.onDragLeave = (w)   => g('zone-'+w).classList.remove('drag-over');
  window.onDrop      = (e,w) => {
    e.preventDefault(); g('zone-'+w).classList.remove('drag-over');
    const f = e.dataTransfer.files[0];
    if (!f || f.type !== 'application/pdf') return;
    const dt = new DataTransfer(); dt.items.add(f);
    g('file-'+w).files = dt.files; window.onFileSelect(w);
  };
  function checkFiles() {
    const ok = g('file-old').files[0] && g('file-new').files[0];
    g('btn-compare').disabled = !ok;
  }

  // ── Run Comparison ───────────────────────────────────────────
  window.runComparison = async function() {
    if (!currentUser) { showPage('login'); return; }
    const oldFile = g('file-old').files[0];
    const newFile = g('file-new').files[0];
    clearErr('err-compare');
    g('btn-retry').style.display = 'none';
    g('upload-panel').style.display = 'none';
    g('proc-panel').classList.add('show');
    g('results-panel').classList.remove('show');
    setStep(1,'active');
    const startTime = Date.now();

    try {
      // Step 1 — extract both PDFs; collect all errors before failing
      setProc('Extracting text from PDFs...', 'Reading policy documents');
      const oldPass = g('pass-old').value || '';
      const newPass = g('pass-new').value || '';

      const [oldResult, newResult] = await Promise.allSettled([
        extractPdf(oldFile, oldPass),
        extractPdf(newFile, newPass)
      ]);
      const errs = [];
      if (oldResult.status === 'rejected') errs.push('Old policy: ' + oldResult.reason.message);
      else if (!oldResult.value) errs.push('Old policy: Could not extract text. The file may be image-based.');
      if (newResult.status === 'rejected') errs.push('New policy: ' + newResult.reason.message);
      else if (!newResult.value) errs.push('New policy: Could not extract text. The file may be image-based.');
      if (errs.length) throw new Error(errs.join('\n'));

      const oldText = oldResult.value;
      const newText = newResult.value;
      // Store for retry — extraction succeeded, so any later failure can retry without re-upload
      lastOldData = { text: oldText, pass: oldPass };
      lastNewData = { text: newText, pass: newPass };
      setStep(1,'done'); setStep(2,'active');

      // Steps 2 & 3
      const notes = g('comparison-notes').value.trim();
      await submitComparison(oldText, newText, notes, oldPass, newPass, startTime);

    } catch(e) {
      g('proc-panel').classList.remove('show');
      g('upload-panel').style.display = 'block';
      showErrMulti('err-compare', e);
      if (lastOldData && lastNewData) g('btn-retry').style.display = 'inline-block';
      resetSteps();
    }
  };

  // ── Retry (skips re-upload, uses stored extraction) ──────────
  window.retryComparison = async function() {
    if (!lastOldData || !lastNewData) return;
    clearErr('err-compare');
    g('btn-retry').style.display = 'none';
    g('upload-panel').style.display = 'none';
    g('proc-panel').classList.add('show');
    g('results-panel').classList.remove('show');
    setStep(1,'done'); setStep(2,'active'); setStep(3,'');
    const notes = g('comparison-notes').value.trim();
    try {
      await submitComparison(lastOldData.text, lastNewData.text, notes, lastOldData.pass, lastNewData.pass, Date.now());
    } catch(e) {
      g('proc-panel').classList.remove('show');
      g('upload-panel').style.display = 'block';
      showErrMulti('err-compare', e);
      g('btn-retry').style.display = 'inline-block';
      resetSteps();
      setStep(1,'done');
    }
  };

  // ── Submit to API (shared by runComparison + retryComparison) ─
  async function submitComparison(oldText, newText, notes, oldPass, newPass, startTime) {
    setProc('Analysing policies with AI...', 'This usually takes 30\u201360 seconds');
    const token = currentUser.token;

    // 3-minute timeout via AbortController
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 180000);
    let resp;
    try {
      resp = await fetch('/api/compare', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ oldPolicyText: oldText, newPolicyText: newText, notes, deviceId: getDeviceId() }),
        signal: controller.signal
      });
    } finally {
      clearTimeout(timer);
    }

    // Handle trial/quota exhausted (402)
    if (resp.status === 402) {
      const d = await resp.json().catch(() => ({}));
      g('proc-panel').classList.remove('show');
      g('upload-panel').style.display = 'block';
      g('results-panel').classList.remove('show');
      resetSteps();
      if (d.error === 'trial_exhausted') {
        showPage('subscribe');
        showSubscribeBanner('You\u2019ve used all 5 free comparisons. Choose a plan to continue.');
      } else if (d.error === 'quota_exceeded') {
        showPage('subscribe');
        showSubscribeBanner('You\u2019ve reached your plan\u2019s comparison limit. Upgrade to continue.');
      } else if (d.error === 'unauthenticated') {
        showPage('login');
      }
      return;
    }

    const result = await resp.json();
    if (!resp.ok) throw new Error(result.error || 'Processing failed. Please try again.');
    setStep(2,'done'); setStep(3,'active');

    setProc('Building your report...', 'Almost done');
    htmlToCopy = buildEmailHtml(result.data, notes);
    await sleep(600);
    setStep(3,'done');
    // Usage tracked server-side
    if (oldPass && g('save-pass-check-old')?.checked) savePassword(oldPass, 'old');
    if (newPass && g('save-pass-check-new')?.checked) savePassword(newPass, 'new');
    if (notes && g('save-note-check')?.checked) saveNote(notes);
    const elapsed = Math.round((Date.now() - startTime) / 1000);
    saveRenewalRecord(result.data?.clientName || 'Unknown Client', elapsed, result.data, result.htmlBody || '', notes);
    renderResults(result.data, 'results-output', notes);
    g('proc-panel').classList.remove('show');
    g('results-panel').classList.add('show');
    if (updateAvailable) g('update-bar').classList.add('show');
  }

  // ── Error helper — handles AbortError, TypeError, multiline ──
  function showErrMulti(id, e) {
    let msg;
    if (e.name === 'AbortError') {
      msg = 'Request timed out after 3 minutes. Please try again.';
    } else if (e.name === 'TypeError') {
      msg = 'Could not connect. Check your internet connection and try again.';
    } else {
      msg = e.message || 'An unexpected error occurred. Please try again.';
    }
    const el = g(id);
    el.innerHTML = msg.split('\n').map(l => l.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')).join('<br>');
    el.className = 'msg-error show';
  }

  function setStep(n, state) {
    const c  = g('ps'+n), l = g('pl'+n), conn = g('pc'+n);
    c.className = 'ps-circle' + (state?' '+state:'');
    l.className = 'ps-label'  + (state?' '+state:'');
    if (conn) conn.className = 'ps-connector' + (state==='done'?' done':'');
    c.textContent = state==='done' ? '\u2713' : n;
  }
  function resetSteps() { [1,2,3].forEach(n => setStep(n,'')); }
  function setProc(main, sub) { g('proc-text').textContent=main; g('proc-sub').textContent=sub; }
  const sleep = ms => new Promise(r => setTimeout(r,ms));

  // ── HTML escape helper (prevents XSS from API data) ──────────
  function esc(s) { const d = document.createElement('div'); d.textContent = String(s||''); return d.innerHTML; }

  // ── Render Results ───────────────────────────────────────────
  function renderResults(d, targetId = 'results-output', notes = '') {
    if (!d) { g(targetId).innerHTML = '<p style="color:var(--gray-600)">No data returned.</p>'; return; }
    const inc   = d.totalDirection === 'increase';
    const arrow = inc ? '&#9650;' : '&#9660;';
    const clr   = inc ? '#dc2626' : '#059669';

    const anyHasSI = d.changes && d.changes.some(c => c.hasInsuredAmount);

    let rows = '';
    if (!d.changes || d.changes.length === 0) {
      rows = `<tr><td colspan="${anyHasSI?6:4}" style="text-align:center;padding:20px;color:var(--gray-600);font-style:italic">No premium changes found.</td></tr>`;
    } else {
      d.changes.forEach(c => {
        const up   = c.difference > 0.01;
        const none = Math.abs(c.difference) < 0.01;
        const cc   = none ? '#94a3b8' : (up ? '#dc2626' : '#059669');
        const ar   = up ? '&#9650;' : '&#9660;';
        const siChanged = c.insuredAmountChanged;
        const siUp      = c.insuredAmountIncreased;
        const siColor   = siChanged ? (siUp ? '#dc2626' : '#059669') : 'var(--gray-700)';
        const siArrow   = siChanged ? (siUp ? ' &#9650;' : ' &#9660;') : '';
        const siOld     = anyHasSI ? `<td style="text-align:right;color:var(--gray-600)">${c.oldInsuredAmountFormatted||'—'}</td>` : '';
        const siAriaLabel = siChanged ? ` aria-label="${siUp?'increased':'decreased'} to ${c.newInsuredAmountFormatted||''}"` : '';
        const siNew     = anyHasSI ? `<td style="text-align:right;color:${siColor};font-weight:${siChanged?'700':'400'}"${siAriaLabel}>${c.newInsuredAmountFormatted||'—'}<span aria-hidden="true">${siArrow}</span></td>` : '';
        const changeAriaLabel = none ? 'No change' : `${up?'Increase':'Decrease'}: ${c.differenceFormatted}`;
        rows += `<tr>
          <td style="font-weight:600">${esc(c.item)}</td>
          <td>${esc(c.oldPriceFormatted||'R0.00')}</td>
          <td>${esc(c.newPriceFormatted||'R0.00')}</td>
          <td><span role="img" aria-label="${changeAriaLabel}" style="color:${cc};font-weight:700">${none?'&mdash;':ar+' '+esc(c.differenceFormatted)}</span></td>
          ${siOld}${siNew}
        </tr>`;
      });
    }

    let bdHtml = '';
    const nb = d.newBreakdown, ob = d.oldBreakdown;
    if (nb || ob) {
      const br = (label,nv,ov) => (nv||ov) ? `<tr><td>${label}</td><td style="color:#059669;font-weight:600;text-align:right">${esc(nv)||'&mdash;'}</td><td style="color:#d97706;font-weight:600;text-align:right">${esc(ov)||'&mdash;'}</td></tr>` : '';
      bdHtml = `<div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--gray-200)">
        <div class="sect-title">Premium Breakdown</div>
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead><tr style="background:var(--navy)">
            <th style="padding:10px;text-align:left;font-weight:600;color:#fff">Component</th>
            <th style="padding:10px;text-align:right;font-weight:600;color:#6ee7b7">New</th>
            <th style="padding:10px;text-align:right;font-weight:600;color:#fcd34d">Previous</th>
          </tr></thead>
          <tbody>
            ${br('Policy Premium',nb?.policyPremium,ob?.policyPremium)}
            ${br('Fees (Intermediary)',nb?.fees,ob?.fees)}
            ${br('Sasria',nb?.sasria,ob?.sasria)}
            ${br('VAS',nb?.vas,ob?.vas)}
            <tr style="background:var(--gray-50);border-top:2px solid var(--gray-200)">
              <td style="padding:10px;font-weight:700;color:var(--navy)">Total</td>
              <td style="padding:10px;font-weight:700;color:#059669;text-align:right">${esc(nb?.total||d.newTotalFormatted)}</td>
              <td style="padding:10px;font-weight:700;color:#d97706;text-align:right">${esc(ob?.total||d.oldTotalFormatted)}</td>
            </tr>
          </tbody>
        </table>
      </div>`;
    }

    const pctChange = (d.oldTotal && d.newTotal && d.oldTotal !== 0)
      ? Math.abs(Math.round(((d.newTotal - d.oldTotal) / d.oldTotal) * 100))
      : null;
    const pctLabel = pctChange !== null ? ` (${pctChange}% ${inc?'increase':'decrease'})` : '';

    g(targetId).innerHTML = `
      <div class="result-box">
        <div class="result-head">
          <div class="result-client">${esc(d.clientName||'Policy Comparison')}</div>
          <div class="result-period">${esc(d.oldPolicyPeriod)} &rarr; ${esc(d.newPolicyPeriod)}</div>
        </div>
        <div class="result-body">
          <div class="totals-row">
            <div class="total-box old"><div class="total-box-label">Previous Premium</div><div class="total-box-amount">${esc(d.oldTotalFormatted)}</div></div>
            <div class="total-box new"><div class="total-box-label">New Premium</div><div class="total-box-amount">${esc(d.newTotalFormatted)}</div></div>
          </div>
          <div class="change-banner ${inc?'inc':'dec'}">
            <span class="cb-text">${arrow} Overall Change: ${esc(d.totalDifferenceFormatted)}${pctLabel}</span>
          </div>
          <div class="sect-title">Cover Items with Changes</div>
          <table class="changes-tbl">
            <thead><tr>
              <th>Cover Item</th>
              <th style="text-align:right">Prev Premium</th>
              <th style="text-align:right">New Premium</th>
              <th style="text-align:right">Change</th>
              ${anyHasSI ? '<th style="text-align:right">Prev Cover</th><th style="text-align:right">New Cover</th>' : ''}
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
          ${bdHtml}
          ${notes ? `<div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--gray-200)"><div class="sect-title">Broker Notes</div><p style="font-size:13px;color:var(--gray-700);line-height:1.7;white-space:pre-wrap;margin:0">${esc(notes)}</p></div>` : ''}
        </div>
      </div>`;
  }

  // ── Build Outlook-Compatible Email HTML ──────────────────────
  function buildEmailHtml(d, notes = '') {
    if (!d) return '';
    const inc       = d.totalDirection === 'increase';
    const arrow     = inc ? '&#9650;' : '&#9660;';
    const bannerBg  = inc ? '#dc2626' : '#059669';
    const newClr    = inc ? '#dc2626' : '#059669';
    const pctChange = (d.oldTotal && d.newTotal && d.oldTotal !== 0)
      ? Math.abs(Math.round(((d.newTotal - d.oldTotal) / d.oldTotal) * 100)) : null;
    const pctLabel  = pctChange !== null ? ` (${pctChange}% ${inc ? 'increase' : 'decrease'})` : '';

    const sectionHeader = (title) => `
<tr><td style="padding:0 32px 0">
  <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:12px">
  <tr>
    <td width="3" bgcolor="#2563eb" style="background:#2563eb;width:3px;font-size:0;line-height:0">&nbsp;</td>
    <td bgcolor="#f8fafc" style="background:#f8fafc;padding:8px 12px">
      <p style="margin:0;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:#0f2744;font-family:Arial,Helvetica,sans-serif">${title}</p>
    </td>
  </tr>
  </table>
</td></tr>`;

    // Changes table rows
    const anyHasSI = d.changes && d.changes.some(c => c.hasInsuredAmount);
    let changeRows = '';
    if (!d.changes || d.changes.length === 0) {
      changeRows = `<tr bgcolor="#ffffff"><td colspan="${anyHasSI?6:4}" style="padding:16px;text-align:center;color:#64748b;font-style:italic;font-family:Arial,Helvetica,sans-serif">No premium changes found.</td></tr>`;
    } else {
      d.changes.forEach((c, i) => {
        const up   = c.difference > 0.01;
        const none = Math.abs(c.difference) < 0.01;
        const cc   = none ? '#94a3b8' : (up ? '#dc2626' : '#059669');
        const ar   = up ? '&#9650;' : '&#9660;';
        const bg   = i % 2 === 0 ? '#f8fafc' : '#ffffff';
        const siChanged = c.insuredAmountChanged;
        const siUp      = c.insuredAmountIncreased;
        const siColor   = siChanged ? (siUp ? '#dc2626' : '#059669') : '#334155';
        const siArrow   = siChanged ? (siUp ? ' &#9650;' : ' &#9660;') : '';
        const siOld = anyHasSI ? `<td bgcolor="${bg}" style="background:${bg};padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:right;color:#334155;font-family:Arial,Helvetica,sans-serif;font-size:13px">${esc(c.oldInsuredAmountFormatted||'&mdash;')}</td>` : '';
        const siNew = anyHasSI ? `<td bgcolor="${bg}" style="background:${bg};padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:right;color:${siColor};font-weight:${siChanged?'700':'400'};font-family:Arial,Helvetica,sans-serif;font-size:13px">${esc(c.newInsuredAmountFormatted||'&mdash;')}${siArrow}</td>` : '';
        changeRows += `<tr bgcolor="${bg}">
          <td bgcolor="${bg}" style="background:${bg};padding:10px 12px;border-bottom:1px solid #e2e8f0;font-weight:600;color:#334155;font-family:Arial,Helvetica,sans-serif;font-size:13px">${esc(c.item)}</td>
          <td bgcolor="${bg}" style="background:${bg};padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:right;color:#334155;font-family:Arial,Helvetica,sans-serif;font-size:13px">${esc(c.oldPriceFormatted||'R0.00')}</td>
          <td bgcolor="${bg}" style="background:${bg};padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:right;color:#334155;font-family:Arial,Helvetica,sans-serif;font-size:13px">${esc(c.newPriceFormatted||'R0.00')}</td>
          <td bgcolor="${bg}" style="background:${bg};padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:right;font-weight:700;color:${cc};font-family:Arial,Helvetica,sans-serif;font-size:13px">${none ? '&mdash;' : ar + ' ' + esc(c.differenceFormatted)}</td>
          ${siOld}${siNew}
        </tr>`;
      });
    }

    // Breakdown table (optional)
    let bdSection = '';
    const nb = d.newBreakdown, ob = d.oldBreakdown;
    if (nb || ob) {
      const bdRow = (label, nv, ov) => (nv || ov) ? `
        <tr bgcolor="#ffffff">
          <td bgcolor="#ffffff" style="background:#ffffff;padding:10px 12px;border-bottom:1px solid #e2e8f0;color:#334155;font-family:Arial,Helvetica,sans-serif;font-size:13px">${label}</td>
          <td bgcolor="#ffffff" style="background:#ffffff;padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:right;color:#059669;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px">${nv || '&mdash;'}</td>
          <td bgcolor="#ffffff" style="background:#ffffff;padding:10px 12px;border-bottom:1px solid #e2e8f0;text-align:right;color:#d97706;font-weight:600;font-family:Arial,Helvetica,sans-serif;font-size:13px">${ov || '&mdash;'}</td>
        </tr>` : '';
      bdSection = `
${sectionHeader('Premium Breakdown')}
<tr><td style="padding:0 32px 24px">
  <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse">
    <thead>
      <tr bgcolor="#0f2744">
        <th bgcolor="#0f2744" style="background:#0f2744;padding:10px 12px;text-align:left;font-weight:600;color:#ffffff;font-family:Arial,Helvetica,sans-serif;font-size:12px">Component</th>
        <th bgcolor="#0f2744" style="background:#0f2744;padding:10px 12px;text-align:right;font-weight:600;color:#6ee7b7;font-family:Arial,Helvetica,sans-serif;font-size:12px">New</th>
        <th bgcolor="#0f2744" style="background:#0f2744;padding:10px 12px;text-align:right;font-weight:600;color:#fcd34d;font-family:Arial,Helvetica,sans-serif;font-size:12px">Previous</th>
      </tr>
    </thead>
    <tbody>
      ${bdRow('Policy Premium', nb?.policyPremium, ob?.policyPremium)}
      ${bdRow('Fees (Intermediary)', nb?.fees, ob?.fees)}
      ${bdRow('Sasria', nb?.sasria, ob?.sasria)}
      ${bdRow('VAS', nb?.vas, ob?.vas)}
      <tr bgcolor="#f1f5f9">
        <td bgcolor="#f1f5f9" style="background:#f1f5f9;padding:12px;font-weight:700;color:#0f2744;font-family:Arial,Helvetica,sans-serif;font-size:13px">Total</td>
        <td bgcolor="#f1f5f9" style="background:#f1f5f9;padding:12px;font-weight:700;color:#059669;text-align:right;font-family:Arial,Helvetica,sans-serif;font-size:13px">${nb?.total || esc(d.newTotalFormatted)}</td>
        <td bgcolor="#f1f5f9" style="background:#f1f5f9;padding:12px;font-weight:700;color:#d97706;text-align:right;font-family:Arial,Helvetica,sans-serif;font-size:13px">${ob?.total || esc(d.oldTotalFormatted)}</td>
      </tr>
    </tbody>
  </table>
</td></tr>`;
    }

    return `<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:v="urn:schemas-microsoft-com:vml">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="x-apple-disable-message-reformatting">
<!--[if mso]><noscript><xml><o:OfficeDocumentSettings><o:PixelsPerInch>96</o:PixelsPerInch></o:OfficeDocumentSettings></xml></noscript><![endif]-->
</head>
<body style="margin:0;padding:0;background:#f1f5f9;font-family:Arial,Helvetica,sans-serif">
<table width="100%" cellpadding="0" cellspacing="0" role="presentation" style="background:#f1f5f9">
<tr><td align="center" style="padding:32px 16px">

<table width="600" cellpadding="0" cellspacing="0" role="presentation" style="width:600px;max-width:600px;background:#ffffff;border-top:4px solid #2563eb">

  <!-- HEADER -->
  <tr bgcolor="#0f2744">
  <td bgcolor="#0f2744" style="background:#0f2744;padding:28px 32px">
    <p style="margin:0;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#93c5fd;font-family:Arial,Helvetica,sans-serif">Policy Renewal Comparison</p>
    <p style="margin:10px 0 0;font-size:22px;font-weight:700;color:#ffffff;font-family:Arial,Helvetica,sans-serif">${esc(d.clientName || 'Policy Comparison')}</p>
    <p style="margin:6px 0 0;font-size:13px;color:#94a3b8;font-family:Arial,Helvetica,sans-serif">${esc(d.oldPolicyPeriod || '')} &rarr; ${esc(d.newPolicyPeriod || '')}</p>
  </td></tr>

  <!-- TOTALS + BANNER -->
  <tr><td style="padding:28px 32px 20px">
    <table width="100%" cellpadding="0" cellspacing="0" role="presentation">
    <tr>
      <td width="48%" bgcolor="#fffbeb" style="background:#fffbeb;padding:16px;border:1px solid #fde68a;border-left:4px solid #d97706">
        <p style="margin:0;font-size:11px;color:#92400e;font-weight:700;text-transform:uppercase;letter-spacing:.8px;font-family:Arial,Helvetica,sans-serif">Previous Premium</p>
        <p style="margin:6px 0 0;font-size:20px;font-weight:700;color:#d97706;font-family:Arial,Helvetica,sans-serif">${esc(d.oldTotalFormatted || '')}</p>
      </td>
      <td width="4%" style="font-size:0;line-height:0">&nbsp;</td>
      <td width="48%" bgcolor="${inc ? '#fff1f2' : '#f0fdf4'}" style="background:${inc ? '#fff1f2' : '#f0fdf4'};padding:16px;border:1px solid ${inc ? '#fecdd3' : '#bbf7d0'};border-left:4px solid ${newClr}">
        <p style="margin:0;font-size:11px;color:${inc ? '#9f1239' : '#14532d'};font-weight:700;text-transform:uppercase;letter-spacing:.8px;font-family:Arial,Helvetica,sans-serif">New Premium</p>
        <p style="margin:6px 0 0;font-size:20px;font-weight:700;color:${newClr};font-family:Arial,Helvetica,sans-serif">${esc(d.newTotalFormatted || '')}</p>
      </td>
    </tr>
    </table>
    <table width="100%" cellpadding="0" cellspacing="0" role="presentation" style="margin-top:12px">
    <tr bgcolor="${bannerBg}">
    <td bgcolor="${bannerBg}" style="background:${bannerBg};padding:14px 16px">
      <p style="margin:0;font-size:15px;font-weight:700;color:#ffffff;font-family:Arial,Helvetica,sans-serif">${arrow} Overall Change: ${esc(d.totalDifferenceFormatted || '')}${pctLabel}</p>
    </td></tr>
    </table>
  </td></tr>

  <!-- CHANGES SECTION -->
  ${sectionHeader('Cover Items with Changes')}
  <tr><td style="padding:0 32px 24px">
    <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse">
      <thead>
        <tr bgcolor="#0f2744">
          <th bgcolor="#0f2744" style="background:#0f2744;padding:10px 12px;text-align:left;font-weight:600;color:#ffffff;font-family:Arial,Helvetica,sans-serif;font-size:12px">Cover Item</th>
          <th bgcolor="#0f2744" style="background:#0f2744;padding:10px 12px;text-align:right;font-weight:600;color:#ffffff;font-family:Arial,Helvetica,sans-serif;font-size:12px">Prev Premium</th>
          <th bgcolor="#0f2744" style="background:#0f2744;padding:10px 12px;text-align:right;font-weight:600;color:#ffffff;font-family:Arial,Helvetica,sans-serif;font-size:12px">New Premium</th>
          <th bgcolor="#0f2744" style="background:#0f2744;padding:10px 12px;text-align:right;font-weight:600;color:#ffffff;font-family:Arial,Helvetica,sans-serif;font-size:12px">Change</th>
          ${anyHasSI ? `<th bgcolor="#0f2744" style="background:#0f2744;padding:10px 12px;text-align:right;font-weight:600;color:#ffffff;font-family:Arial,Helvetica,sans-serif;font-size:12px">Prev Cover</th><th bgcolor="#0f2744" style="background:#0f2744;padding:10px 12px;text-align:right;font-weight:600;color:#ffffff;font-family:Arial,Helvetica,sans-serif;font-size:12px">New Cover</th>` : ''}
        </tr>
      </thead>
      <tbody>${changeRows}</tbody>
    </table>
  </td></tr>

  <!-- BREAKDOWN SECTION (conditional) -->
  ${bdSection}

  <!-- BROKER NOTES (conditional) -->
  ${notes ? `
  ${sectionHeader('Broker Notes')}
  <tr><td style="padding:0 32px 28px">
    <p style="margin:0;font-size:13px;color:#334155;line-height:1.8;font-family:Arial,Helvetica,sans-serif;white-space:pre-wrap">${esc(notes).replace(/\n/g,'<br>')}</p>
  </td></tr>` : ''}

</table>
</td></tr>
</table>
</body></html>`;
  }

  // ── Copy HTML ────────────────────────────────────────────────
  window.doCopyHtml = async function(btnId = 'btn-copy') {
    if (!htmlToCopy) return;
    const btn = g(btnId);
    try {
      await navigator.clipboard.write([new ClipboardItem({
        'text/html':  new Blob([htmlToCopy], { type:'text/html' }),
        'text/plain': new Blob([htmlToCopy.replace(/<[^>]+>/g,'')], { type:'text/plain' })
      })]);
    } catch {
      const ta = document.createElement('textarea');
      ta.value = htmlToCopy; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
    }
    if (btn) { btn.textContent = '\u2713 Copied!'; btn.classList.add('copied'); }
    const t = g('toast'); t.classList.add('show');
    setTimeout(() => { if (btn) { btn.textContent='\uD83D\uDCCB Copy HTML for Email'; btn.classList.remove('copied'); } t.classList.remove('show'); }, 3000);
  };

  // ── Download PDF ─────────────────────────────────────────────
  window.doPrintPdf = function(elementId = 'results-output') {
    const el = g(elementId);
    if (!el || !el.querySelector('.result-box')) return;
    const clientName = el.querySelector('.result-client')?.textContent || 'Policy-Comparison';
    const filename = clientName.replace(/[^a-z0-9\s]/gi, '').trim().replace(/\s+/g, '-') + '-comparison.pdf';
    const btn = elementId === 'viewer-results-output' ? g('viewer-download-btn') : g('btn-pdf');
    if (btn) { btn.textContent = '\u23f3 Generating...'; btn.disabled = true; }
    html2pdf().set({
      margin: [10, 10, 10, 10],
      filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, logging: false },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(el).save().then(() => {
      if (btn) { btn.textContent = '\u2713 Downloaded'; btn.disabled = false; setTimeout(() => { btn.textContent = '\u2b07 Download PDF'; btn.disabled = false; }, 2500); }
    }).catch(() => {
      if (btn) { btn.textContent = '\u2b07 Download PDF'; btn.disabled = false; }
    });
  };

  window.resetCompare = function() {
    htmlToCopy = '';
    lastOldData = null;
    lastNewData = null;
    g('btn-retry').style.display = 'none';
    ['old','new'].forEach(w => {
      g('zone-'+w).classList.remove('loaded');
      g('fn-'+w).textContent = '';
      g('file-'+w).value = '';
      g('pass-'+w).value = '';
      g('pass-trigger-label-' + w).textContent = 'PDF password (if protected)';
      g('pass-trigger-label-' + w).style.color = '';
    });
    g('btn-compare').disabled = true;
    g('comparison-notes').value = '';
    const nl = g('notes-saved-list'); if (nl) nl.style.display = 'none';
    const snl = g('save-note-label'); if (snl) snl.style.display = 'none';
    const snc = g('save-note-check'); if (snc) snc.checked = false;
    ['old','new'].forEach(w => {
      const spl = g('save-pass-label-' + w); if (spl) spl.style.display = 'none';
      const spc = g('save-pass-check-' + w); if (spc) spc.checked = false;
    });
    clearErr('err-compare');
    g('results-panel').classList.remove('show');
    g('upload-panel').style.display = 'block';
    resetSteps();
  };

  function autoFillSavedPasswords() {
    const saved = getSavedPasswords();
    if (!saved.length) return;
    const pw = saved[0];
    ['old', 'new'].forEach(w => {
      g('pass-' + w).value = pw;
      const lbl = g('pass-trigger-label-' + w);
      lbl.textContent = pw;
      lbl.style.color = 'var(--gray-700)';
    });
  }

  // ── Page navigation ──────────────────────────────────────────
  window.showPage = function(page) {
    // Hard gate — logged-out users cannot access protected pages
    const gated = ['dashboard','compare','viewer','settings','team'];
    if (gated.includes(page) && !currentUser) { page = 'login'; }
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const el = document.getElementById('page-' + page);
    if (el) { el.classList.add('active'); currentPage = page; window.scrollTo(0,0); }
    // Remember page across refreshes (skip transient/auth pages)
    if (!['verify','login','signup'].includes(page)) sessionStorage.setItem('rs_page', page);
    if (page === 'dashboard') loadRenewals();
    if (page === 'compare') { autoFillSavedPasswords(); renderNoteTemplates(); }
    if (page === 'team') loadTeam();
    if (page === 'settings') loadSettingsPage();
    if (page === 'subscribe') { const sb = g('subscribe-banner'); if (sb) sb.style.display = 'none'; }
  };

  window.scrollToPricing = function() {
    showPage('landing');
    setTimeout(() => document.getElementById('pricing-section')?.scrollIntoView({behavior:'smooth'}), 100);
  };

  // ── Utilities ────────────────────────────────────────────────
  const g = id => document.getElementById(id);
  function showErr(id, msg) { const el=g(id); el.textContent=msg; el.className='msg-error show'; }
  function clearErr(id) { g(id).className='msg-error'; }
  function showOk(id, msg) { const el=g(id); el.textContent=msg; el.className='msg-success show'; }
  function clearOk(id) { g(id).className='msg-success'; }
  function showSubscribeBanner(msg) { const el = g('subscribe-banner'); if (!el) return; el.textContent = msg; el.style.display = 'block'; }

  // ── PDF Password Manager ─────────────────────────────────────
  function passStorageKey(side) {
    const uid = currentUser ? currentUser.userId : 'guest';
    return 'pdfpasses_' + side + '_' + uid;
  }
  function getSavedPasswords(side) {
    try { return JSON.parse(localStorage.getItem(passStorageKey(side)) || '[]'); } catch { return []; }
  }
  function savePassword(pw, side) {
    if (!pw || !side) return;
    let list = getSavedPasswords(side);
    if (list.includes(pw)) return;
    list.unshift(pw);
    if (list.length > 20) list = list.slice(0, 20);
    localStorage.setItem(passStorageKey(side), JSON.stringify(list));
    showPassSavedWarning();
  }

  function showPassSavedWarning() {
    if (sessionStorage.getItem('rs_pass_warn_shown')) return;
    sessionStorage.setItem('rs_pass_warn_shown', '1');
    const el = document.createElement('div');
    el.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1a3c5e;color:#fff;padding:14px 20px;border-radius:8px;font-size:13px;line-height:1.6;max-width:440px;width:90%;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:flex;align-items:flex-start;gap:12px';
    el.innerHTML = '<span style="font-size:18px;flex-shrink:0">&#128274;</span><span>Password saved to this browser only. Anyone with access to this device can read saved passwords — clear them when using shared devices.<button onclick="this.closest(\'div\').remove()" style="margin-left:12px;background:rgba(255,255,255,0.2);border:none;color:#fff;padding:3px 10px;border-radius:4px;cursor:pointer;font-size:12px;vertical-align:middle">Dismiss</button></span>';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 10000);
  }
  function deletePassword(pw, side) {
    let list = getSavedPasswords(side).filter(p => p !== pw);
    localStorage.setItem(passStorageKey(side), JSON.stringify(list));
  }

  function renderPassList(which) {
    const list = getSavedPasswords(which);
    const container = g('pass-saved-list-' + which);
    if (!list.length) { container.innerHTML = ''; return; }
    container.innerHTML = list.map((pw, i) => `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;cursor:pointer;border-bottom:1px solid var(--gray-100);font-size:13px;color:var(--gray-700);background:#fff;transition:background .1s"
           onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#fff'">
        <span onclick="selectSavedPass('${which}','${pw.replace(/'/g,"\\'")}')">
          ${pw}
        </span>
        <span onclick="deleteSavedPass(event,'${which}','${pw.replace(/'/g,"\\'")}',${i})"
              style="color:var(--gray-400);font-size:14px;padding:2px 6px;border-radius:4px;cursor:pointer;line-height:1"
              onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--gray-400)'"
              title="Delete this saved password">&#10005;</span>
      </div>`).join('');
  }

  window.togglePassDropdown = function(which) {
    const dd = g('pass-dropdown-' + which);
    const isOpen = dd.style.display !== 'none';
    // close both first
    ['old','new'].forEach(w => { g('pass-dropdown-' + w).style.display = 'none'; });
    if (!isOpen) {
      renderPassList(which);
      dd.style.display = 'block';
      setTimeout(() => g('pass-' + which).focus(), 50);
    }
  };

  window.selectSavedPass = function(which, pw) {
    g('pass-' + which).value = pw;
    const label = g('pass-trigger-label-' + which);
    label.textContent = pw;
    label.style.color = 'var(--gray-700)';
    g('pass-dropdown-' + which).style.display = 'none';
  };

  window.deleteSavedPass = function(e, which, pw, idx) {
    e.stopPropagation();
    deletePassword(pw, which);
    const input = g('pass-' + which);
    const label = g('pass-trigger-label-' + which);
    if (input.value === pw) {
      input.value = '';
      label.textContent = 'PDF password (if protected)';
      label.style.color = '';
      const saveLbl = g('save-pass-label-' + which);
      if (saveLbl) saveLbl.style.display = 'none';
    }
    renderPassList(which);
  };

  window.onPassInput = function(which) {
    const val = g('pass-' + which).value;
    const label = g('pass-trigger-label-' + which);
    if (val) {
      label.textContent = val;
      label.style.color = 'var(--gray-700)';
    } else {
      label.textContent = 'PDF password (if protected)';
      label.style.color = '';
    }
    const saveLbl = g('save-pass-label-' + which);
    if (saveLbl) saveLbl.style.display = val ? 'flex' : 'none';
  };

  // Close dropdowns when clicking outside
  document.addEventListener('click', (e) => {
    ['old','new'].forEach(w => {
      const wrap = g('pass-wrap-' + w);
      if (wrap && !wrap.contains(e.target)) {
        g('pass-dropdown-' + w).style.display = 'none';
      }
    });
    const notesWrap = g('notes-wrap');
    if (notesWrap && !notesWrap.contains(e.target)) {
      closeSavedNotesList();
    }
  });

  // ── Notes Manager ─────────────────────────────────────────────
  function notesStorageKey() {
    return currentUser ? 'pdfnotes_' + currentUser.userId : 'pdfnotes_guest';
  }
  function getSavedNotes() {
    try { return JSON.parse(localStorage.getItem(notesStorageKey()) || '[]'); } catch { return []; }
  }
  function saveNote(note) {
    if (!note) return;
    let list = getSavedNotes();
    if (list.includes(note)) return;
    list.unshift(note);
    if (list.length > 20) list = list.slice(0, 20);
    localStorage.setItem(notesStorageKey(), JSON.stringify(list));
  }
  function deleteNote(note) {
    let list = getSavedNotes().filter(n => n !== note);
    localStorage.setItem(notesStorageKey(), JSON.stringify(list));
  }

  window.renderSavedNotesList = function() {
    const list = getSavedNotes();
    const container = g('notes-saved-list');
    const wrap = g('notes-wrap');
    if (!container) return;
    if (!list.length) {
      container.style.display = 'none';
      return;
    }
    container.style.display = 'block';
    const header = `<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border-bottom:1px solid var(--gray-100);background:#f8fafc">
      <span style="font-size:11px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:0.4px">Saved notes</span>
      <span onclick="closeSavedNotesList()" onmousedown="event.preventDefault()" style="cursor:pointer;color:var(--gray-400);font-size:16px;padding:0 6px;line-height:1;border-radius:4px" onmouseover="this.style.color='var(--gray-700)'" onmouseout="this.style.color='var(--gray-400)'" title="Close">&#10005;</span>
    </div>`;
    container.innerHTML = header + list.map((note, i) => {
      const preview = note.length > 80 ? note.slice(0, 80) + '…' : note;
      const safe = note.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--gray-100);font-size:13px;color:var(--gray-700);background:#fff;transition:background .1s;gap:8px"
           onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#fff'">
        <span style="cursor:pointer;flex:1;line-height:1.4" onmousedown="event.preventDefault()" onclick="selectSavedNote('${safe}')">${preview}</span>
        <span onclick="deleteSavedNote(event,'${safe}')" onmousedown="event.preventDefault()"
              style="color:var(--gray-400);font-size:14px;padding:2px 6px;border-radius:4px;cursor:pointer;flex-shrink:0"
              onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--gray-400)'"
              title="Delete this saved note">&#10005;</span>
      </div>`;
    }).join('');
  };

  window.closeSavedNotesList = function() {
    const nl = g('notes-saved-list'); if (nl) nl.style.display = 'none';
  };

  window.selectSavedNote = function(note) {
    g('comparison-notes').value = note;
    closeSavedNotesList();
  };

  window.deleteSavedNote = function(e, note) {
    e.stopPropagation();
    deleteNote(note);
    if (g('comparison-notes').value === note) g('comparison-notes').value = '';
    renderSavedNotesList();
  };

  window.toggleSaveNoteCheckbox = function() {
    const val = g('comparison-notes').value.trim();
    const lbl = g('save-note-label');
    if (lbl) lbl.style.display = val ? 'flex' : 'none';
  };

  // ── Note Templates ────────────────────────────────────────────
  function noteTemplatesKey() {
    return currentUser ? 'pdfnote_templates_' + currentUser.userId : 'pdfnote_templates_guest';
  }
  function getNoteTemplates() {
    try { return JSON.parse(localStorage.getItem(noteTemplatesKey()) || '[]'); } catch { return []; }
  }
  window.renderNoteTemplates = function() {
    const row = g('note-templates-row');
    if (!row) return;
    const templates = getNoteTemplates();
    const hasContent = (g('comparison-notes')?.value || '').trim().length > 0;
    const canSave = templates.length < 3 && hasContent;
    const pills = templates.map((t, i) => {
      const label = t.length > 32 ? t.slice(0, 32) + '\u2026' : t;
      const safe = t.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      return `<span style="display:inline-flex;align-items:center;gap:5px;background:var(--gray-100);border:1px solid var(--gray-200);border-radius:20px;padding:4px 10px 4px 12px;font-size:12px;color:var(--navy)" title="${t.replace(/"/g,'&quot;')}">
        <span style="cursor:pointer" onclick="applyNoteTemplate('${safe}')">${label}</span>
        <span onclick="deleteNoteTemplate(${i})" style="color:var(--gray-400);font-size:13px;cursor:pointer;line-height:1" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--gray-400)'">&times;</span>
      </span>`;
    }).join('');
    const saveBtn = canSave
      ? `<button onclick="saveNoteTemplate()" style="background:none;border:1px dashed var(--gray-300);color:var(--gray-500);border-radius:20px;padding:4px 12px;font-size:12px;cursor:pointer;font-family:Inter,sans-serif">+ Save as Template</button>`
      : '';
    row.innerHTML = pills + saveBtn;
    row.style.display = (templates.length > 0 || canSave) ? 'flex' : 'none';
  };
  window.applyNoteTemplate = function(text) {
    const ta = g('comparison-notes');
    if (ta) { ta.value = text; ta.dispatchEvent(new Event('input')); }
    renderNoteTemplates();
  };
  window.saveNoteTemplate = function() {
    const text = (g('comparison-notes')?.value || '').trim();
    if (!text) return;
    const templates = getNoteTemplates();
    if (templates.length >= 3 || templates.includes(text)) return;
    templates.push(text);
    localStorage.setItem(noteTemplatesKey(), JSON.stringify(templates));
    renderNoteTemplates();
  };
  window.deleteNoteTemplate = function(i) {
    const templates = getNoteTemplates();
    templates.splice(i, 1);
    localStorage.setItem(noteTemplatesKey(), JSON.stringify(templates));
    renderNoteTemplates();
  };

  // Show saved notes list when textarea is focused
  document.addEventListener('DOMContentLoaded', () => {
    const ta = g('comparison-notes');
    if (ta) { ta.addEventListener('focus', renderSavedNotesList); }
    renderNoteTemplates();
    document.querySelectorAll('.app-ver').forEach(el => el.textContent = 'v' + APP_VERSION);
  });


  // ── Comparison Viewer ────────────────────────────────────────
  window.viewStoredComparison = function(index) {
    try {
      const list = JSON.parse(localStorage.getItem(renewalsKey()) || '[]');
      const record = list[index];
      if (!record || !record.result) { showErr('err-dashboard', 'Full result data is not available for this comparison. Only new comparisons are viewable.'); return; }
      htmlToCopy = record.result ? buildEmailHtml(record.result, record.notes || '') : '';
      showPage('viewer');
      renderViewerResult(record);
    } catch(e) {
      console.warn('Failed to load stored comparison', e);
      showErr('err-dashboard', 'Could not load this comparison. Please try again.');
    }
  };

  function renderViewerResult(record) {
    const d = record.completedAt ? new Date(record.completedAt) : new Date();
    const dateStr = d.toLocaleDateString('en-ZA', { day:'2-digit', month:'short', year:'numeric' });
    const el = g('viewer-meta');
    if (el) el.textContent = (record.clientName || 'Unknown Client') + ' \u2014 ' + dateStr;
    const copyBtn = g('viewer-copy-btn');
    if (copyBtn) copyBtn.style.display = record.result ? '' : 'none';
    g('viewer-results-output').innerHTML = '';
    renderResults(record.result, 'viewer-results-output', record.notes || '');
  }

  window.viewerPrintPdf = function() { doPrintPdf('viewer-results-output'); };

  initAuth();

</script>
</body>
</html>
